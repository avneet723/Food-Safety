4ac7a4376341470f85c54bc8e60ef1c6
jsio("import std.base64 as base64");jsio("import std.utf8 as utf8");jsio("import std.uri as uri");jsio("import net.errors as errors");jsio("import .transports");jsio("import lib.Enum as Enum");var READYSTATE=exports.READYSTATE=Enum({INITIAL:0,CONNECTING:1,CONNECTED:2,DISCONNECTING:3,DISCONNECTED:4});exports.CometSession=__class__;
exports.CometSession=exports.CometSession(function(){return this.init&&this.init.apply(this,arguments)},function(){var d=0;this.init=function(){this._id=++d;this._url=null;this.readyState=READYSTATE.INITIAL;this._options=this._transport=this._sessionKey=null;this._writeBuffer=this._utf8ReadBuffer="";this._handshakeLater=this._lastSentId=this._lastEventId=this._packetsInFlight=null;this._handshakeBackoff=50;this._timeoutTimer=this._handshakeTimeoutTimer=this._handshakeRetryTimer=null;this._cometBackoff=
this._writeBackoff=50;this._nullReceived=this._nullSent=this._nullInFlight=this._nullInBuffer=!1};this.setEncoding=function(a){if(a!=this._options.encoding){if("utf8"!=a&&"plain"!=a)throw new errors.InvalidEncodingError;if("plain"==a&&this._buffer){var b=this._utf8ReadBuffer;this._utf8ReadBuffer="";this._doOnRead(b)}this._options.encoding=a}};this.connect=function(a,b){this._url=a.replace(/\/$/,"");this._options=b||{};this._options.encoding=this._options.encoding||"utf8";this.setEncoding(this._options.encoding);
this._options.connectTimeout=this._options.connectTimeout||1E4;this._transport=new (transports.chooseTransport(a,this._options));this._transport.handshakeFailure=bind(this,this._handshakeFailure);this._transport.handshakeSuccess=bind(this,this._handshakeSuccess);this._transport.cometFailure=bind(this,this._cometFailure);this._transport.cometSuccess=bind(this,this._cometSuccess);this._transport.sendFailure=bind(this,this._writeFailure);this._transport.sendSuccess=bind(this,this._writeSuccess);this.readyState=
READYSTATE.CONNECTING;this._transport.handshake(this._url,this._options);this._handshakeTimeoutTimer=setTimeout(bind(this,this._handshakeTimeout),this._options.connectTimeout)};this.write=function(a,b){if(this.readyState!=READYSTATE.CONNECTED)throw new errors.ReadyStateError;b=b||this._options.encoding||"utf8";"utf8"==b&&(a=utf8.encode(a));this._writeBuffer+=a;this._doWrite()};this._protocolError=function(a){logger.debug("_protocolError",a);this.readyState=READYSTATE.DISCONNECTED;this._doWrite(!0);
this._doOnDisconnect(new errors.ServerProtocolError(a))};this._receivedNullPacket=function(){logger.debug("_receivedNullPacket");this._receivedNull=!0;!this._nullInFlight&&!this._nullInBuffer&&!this._nullSent?(this.readyState=READYSTATE.DISCONNECTING,this._doWrite(!0)):this.readyState=READYSTATE.DISCONNECTED;this._doOnDisconnect(new errors.ConnectionClosedCleanly)};this._sentNullPacket=function(){logger.debug("_sentNullPacket");if((this._nullSent=!0)&&this._nullReceived)this.readyState=READYSTATE.DISCONNECTED};
this.close=function(a){logger.debug("close called",a,"readyState",this.readyState);switch(this.readyState){case READYSTATE.CONNECTING:clearTimeout(this._handshakeRetryTimer);clearTimeout(this._handshakeTimeoutTimer);this.readyState=READYSTATE.DISCONNECTED;this._doOnDisconnect(a);break;case READYSTATE.CONNECTED:this.readyState=READYSTATE.DISCONNECTING;this._doWrite(!0);clearTimeout(this._timeoutTimer);break;case READYSTATE.DISCONNECTED:throw new errors.ReadyStateError("Session is already disconnected");
}this._opened=!1;this.readyState=READYSTATE.DISCONNECTED;this._doOnDisconnect(a);this._sessionKey=null};this._handshakeTimeout=function(){logger.debug("handshake timeout");this._handshakeTimeoutTimer=null;clearTimeout(this._handshakeRetryTimer);this.readyState==READYSTATE.CONNECTING&&(this.readyState=READYSTATE.DISCONNECTED);this._doOnDisconnect(new errors.ServerUnreachable)};this._handshakeSuccess=function(a){logger.debug("handshake success",a);this.readyState!=READYSTATE.CONNECTING?logger.debug("received handshake success in invalid readyState:",
this.readyState):(clearTimeout(this._handshakeTimeoutTimer),this._handshakeTimeoutTimer=null,this._sessionKey=a.response.session,this._opened=!0,this.readyState=READYSTATE.CONNECTED,this._doOnConnect(),this._doConnectComet())};this._handshakeFailure=function(a){logger.debug("handshake failure",a);if(this.readyState==READYSTATE.CONNECTING){if(404==a.status)return clearTimeout(this._handshakeTimeoutTimer),this._doOnDisconnect(new errors.ServerUnreachable);logger.debug("trying again in ",this._handshakeBackoff);
this._handshakeRetryTimer=setTimeout(bind(this,function(){this._handshakeRetryTimer=null;this._transport.handshake(this._url,this._options)}),this._handshakeBackoff);this._handshakeBackoff*=2}};this._writeSuccess=function(){if(!(this.readyState!=READYSTATE.CONNECTED&&this.readyState!=READYSTATE.DISCONNECTING)){if(this._nullInFlight)return this._sentNullPacket();this._resetTimeoutTimer();this.writeBackoff=50;this._packetsInFlight=null;(this._writeBuffer||this._nullInBuffer)&&this._doWrite(this._nullInBuffer)}};
this._writeFailure=function(){this.readyState!=READYSTATE.CONNECTED&&this.READYSTATE!=READYSTATE.DISCONNECTING||(this._writeTimer=setTimeout(bind(this,function(){this._writeTimer=null;this.__doWrite(this._nullInBuffer)}),this._writeBackoff),this._writeBackoff*=2)};this._doWrite=function(a){this._packetsInFlight?a&&(this._nullInBuffer=!0):this.__doWrite(a)};this.__doWrite=function(a){logger.debug("_writeBuffer:",this._writeBuffer);!this._packetsInFlight&&this._writeBuffer&&(this._packetsInFlight=[this._transport.encodePacket(++this._lastSentId,
this._writeBuffer,this._options)],this._writeBuffer="");a&&!this._writeBuffer&&(this._packetsInFlight||(this._packetsInFlight=[]),this._packetsInFlight.push([++this._lastSentId,0,null]),this._nullInFlight=!0);this._packetsInFlight?(logger.debug("sending packets:",JSON.stringify(this._packetsInFlight)),this._transport.send(this._url,this._sessionKey,this._lastEventId||0,JSON.stringify(this._packetsInFlight),this._options)):logger.debug("no packets to send")};this._doConnectComet=function(){logger.debug("_doConnectComet");
this._transport.comet(this._url,this._sessionKey,this._lastEventId||0,this._options)};this._cometFailure=function(a){if(this.readyState==READYSTATE.CONNECTED){if(404==a.status&&"Session not found"==a.response)return this.close(new errors.ExpiredSession(a));this._cometTimer=setTimeout(bind(this,"_doConnectComet"),this._cometBackoff);this._cometBackoff*=2}};this._cometSuccess=function(a){if(!(this.readyState!=READYSTATE.CONNECTED&&this.readyState!=READYSTATE.DISCONNECTING)){logger.debug("comet Success:",
a);this._cometBackoff=50;this._resetTimeoutTimer();for(var b=a.response,e=0,c;(c=b[e])||e<b.length;e++){logger.debug("process packet:",c);if(null===c)return this.close(new errors.ServerProtocolError(a));logger.debug("process packet",c);var f=c[0],d=c[1],a=c[2];if(!("number"==typeof this._lastEventId&&f<=this._lastEventId)){if("number"==typeof this._lastEventId&&f!=this._lastEventId+1)return this._protocolError("Ack id too high");this._lastEventId=f;if(null==a)return this._receivedNullPacket();if(1==
d)try{logger.debug("before base64 decode:",a),a=base64.decode(a),logger.debug("after base64 decode:",a)}catch(g){return this._protocolError("Unable to decode base64 payload")}"utf8"==this._options.encoding&&(this._utf8ReadBuffer+=a,logger.debug("before utf8 decode, _utf8ReadBuffer:",this._utf8ReadBuffer),c=utf8.decode(this._utf8ReadBuffer),a=c[0],this._utf8ReadBuffer=this._utf8ReadBuffer.slice(c[1]),logger.debug("after utf8 decode, _utf8ReadBuffer:",this._utf8ReadBuffer,"data:",a));logger.debug("dispatching data:",
a);this._doOnRead(a)}}this.readyState!=READYSTATE.CONNECTED&&this.readyState!=READYSTATE.DISCONNECTING||this._doConnectComet()}};this._doOnRead=function(a){"function"==typeof this.onread?(logger.debug("call onread function",a),this.onread(a)):logger.debug("skipping onread callback (function missing)")};this._doOnDisconnect=function(a){"function"==typeof this.ondisconnect?(logger.debug("call ondisconnect function",a),this.ondisconnect(a)):logger.debug("skipping ondisconnect callback (function missing)")};
this._doOnConnect=function(){if("function"==typeof this.onconnect){logger.debug("call onconnect function");try{this.onconnect()}catch(a){logger.debug("onconnect caused errror",a),setTimeout(function(){throw a;},0)}}else logger.debug("skipping onconnect callback (function missing)")};this._resetTimeoutTimer=function(){clearTimeout(this._timeoutTimer);this._timeoutTimer=setTimeout(bind(this,function(){logger.debug("connection timeout expired");this.close(new errors.ConnectionTimeout)}),this._getTimeoutInterval())};
this._getTimeoutInterval=function(){return 45E3}});
