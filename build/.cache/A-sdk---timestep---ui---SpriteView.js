045129e6cea259ef7e4de510abf20056
jsio("import ui.ImageView as ImageView");jsio("import ui.resource.Image as Image");jsio("import ui.resource.loader");
var sdk_timestep_ui_SpriteView=__class__,SpriteView=exports=sdk_timestep_ui_SpriteView(function(){return this.init&&this.init.apply(this,arguments)},"SpriteView",ImageView,function(c,g){this.defaults={url:null,groupID:"default",frameRate:15,delay:0,emitFrameEvents:!1,autoStart:!1,loop:!0};var f={};this.init=function(a){this._opts=a=merge(a,this.defaults);a.visible=!1;g(this,"init",[a]);this.resetAllAnimations(a)};this.resetAllAnimations=function(a){this.stopAnimation();this._opts=a=merge(a,this.defaults);
var b=SpriteView.allAnimations[a.url];this.groupID=a.groupID;this.frameRate=a.frameRate;f[this.groupID]||(f[this.groupID]=new Group);this._animations={};var d=null,e=null,h;for(h in b){this._opts.defaultAnimation||(this._opts.defaultAnimation=h);this.addAnimation(h,b[h]);var c=this._animations[h].frames;!d&&c[0]&&(d=c[0].getWidth(),e=c[0].getHeight())}a.autoSize&&(this.style.width=d,this.style.height=e);a.autoStart&&this.startAnimation(this._opts.defaultAnimation,a)};this.addAnimation=function(a,
b){isArray(b)||(b=SpriteView.allAnimations[b][a]);for(var d=[],e=0,c;c=b[e];e++)d.push(new Image({url:c.url}));this._animations[a]={frames:d}};this.getFrame=function(a,b){return this._animations[a].frames[b]};this.getFrameCount=function(a){return this._animations[a].frames.length};this.getGroup=function(a){return f[a||this.groupID]};this.startAnimation=function(a,b){b=b||{};!0===b.randomFrame&&null==b.frame&&(b.frame=Math.random()*this._animations[a].frames.length|0);!0===b.loop&&(b.iterations=Infinity);
this._iterationsLeft=b.iterations||1;this._callback=b.callback||null;this._currentAnimationName=a;this._currentFrame=b.frame||0;this._delay=this._dt=0;if(!this._animations[a])throw Error("Animation "+a+" does not exist: "+this._opts.url+".");this.isPlaying||(GC.app.engine.subscribe("Tick",this,"_tickSprite"),f[this.groupID].add(this),this.isPlaying=this.running=!0,this.style.visible=!0);this._tickSprite(0)};this.stopAnimation=function(){this.isPlaying&&(this.style.visible=!1,GC.app.engine.unsubscribe("Tick",
this,"_tickSprite"),this.isPaused=this._isPaused=this.isPlaying=this.running=!1,f[this.groupID].remove(this.uid))};this.resetAnimation=function(){this._opts.loop?this.startAnimation(this._opts.defaultAnimation):this.stopAnimation()};this.setFramerate=function(a){this.frameRate=a||1.0E-5};this.pause=function(){this.isPaused=this._isPaused=!0};this.resume=function(){this.isPaused=this._isPaused=!1};this._tickSprite=function(a){if(!this.isPaused)if(a+=this._dt,this._delay)this._delay-=a,0>this._delay&&
(this._delay=0);else{var b=this._animations[this._currentAnimationName],d=1E3/this.frameRate,e=a/d|0,c=this._currentFrame;this._dt=a-e*d;this._currentFrame=(this._currentFrame+e)%b.frames.length;0>this._currentFrame&&(this._currentFrame+=b.frames.length);if(0!==e||0===a)if(this.setImage(this._animations[this._currentAnimationName].frames[this._currentFrame]),this._opts.emitFrameEvents)for(a=0;a<e;a++)this.publish(this._currentAnimationName+"_"+(c+a)%b.frames.length);(c+e)/b.frames.length|0&&(this._delay=
this._opts.delay,0>=--this._iterationsLeft&&(b=this._callback,this._callback=null,this.resetAnimation(),b&&b()))}}});SpriteView.allAnimations={};SpriteView.getGroup=SpriteView.prototype.getGroup;(function(){var c=ui.resource.loader.getMap(),g=SpriteView.allAnimations,f=Object.keys(c);f.sort();for(var a in f){var b=f[a],d=/((?:.*)\/.*?)[-_ ](.*?)[-_ ](\d+)/.exec(b);if(d){var e=d[1],d=d[2],e=g[e]||(g[e]={}),e=e[d]||(e[d]=[]),d=c[b];d.url=b;e.push(d)}}})();
var Group=__class__,Group=Group(function(){return this.init&&this.init.apply(this,arguments)},jsio.__filename,function(){this.init=function(){this.sprites={}};this.add=function(c){this.sprites[c.uid]=c};this.remove=function(c){delete this.sprites[c]};this.pause=function(){this._forEachSprite("pause")};this.resume=function(){this._forEachSprite("resume")};this.stopAnimation=function(){this._forEachSprite("stopAnimation")};this.resetAnimation=function(){this._forEachSprite("resetAnimation")};this._forEachSprite=
function(c){for(var g in this.sprites)this.sprites[g][c]()}});
