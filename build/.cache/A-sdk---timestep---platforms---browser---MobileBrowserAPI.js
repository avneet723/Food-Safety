aa37acc3af7a52ecc0f57d4ff67b7f9f
jsio("import lib.PubSub");jsio("import device");jsio("from util.underscore import _");
var sdk_timestep_platforms_browser_MobileBrowserAPI=__class__,AudioAPI=exports=sdk_timestep_platforms_browser_MobileBrowserAPI(function(){return this.init&&this.init.apply(this,arguments)},lib.PubSub,function(e){var f={oneChannelOnly:device.isMobileBrowser,compiledFilename:"compiled"};this.init=function(a){a=merge(a,f);e(this,"init",[a]);this._opts=a;this._map=a.map;this._audios={};this.oneChannelOnly=a.oneChannelOnly;setInterval(bind(this,"_ontimeupdate"),200);this.oneChannelOnly||_.each(a.background,
function(b){a.map[b]={name:b}},this);this._load();this.oneChannelOnly&&(this._boundLoadHandler=bind(this,"_playFirst"),document.body.addEventListener(device.events.start,this._boundLoadHandler,!0));window.addEventListener("pagehide",bind(this,"pause"),!1)};this._createChannel=function(a,b){var c=new Audio(b);this._audios[a]=c;c.addEventListener("error",bind(this,"_onerror"));c.addEventListener("timeupdate",bind(this,"_ontimeupdate"));c.load()};this.setMuted=function(a){(this.muted=a)&&this.setVolume(0)};
this.setVolume=function(a){_.each(this._audios,function(b){b.volume=a})};this.unload=function(){this.pause();_.each(this._audios,function(a){a.src=""},this)};this._load=function(){this._audios={};var a=this._opts.path.replace(/\/$/,"");if(this.oneChannelOnly)this._createChannel("AUDIO",a+"/"+this._opts.compiledFilename+".m4a");else for(var b in this._map)this._map.hasOwnProperty(b)&&"SILENCE"!=b&&this._createChannel(b,a+"/"+b+".mp3");logger.info("now loading",this._opts.src);this._publishedReady||
(this.publish("Ready"),this._publishedReady=!0)};this._playFirst=function(){document.body.removeEventListener(device.events.start,this._boundLoadHandler,!0);this._audios.AUDIO.play()};this._ontimeupdate=function(){_.each(this._audios,function(a){a.paused&&!a._pausedOnce&&(a.pause(),a._pausedOnce=!0,a._ready=!0);this.oneChannelOnly&&(!this._nowPlaying||a.currentTime>=this._nowPlaying.end)&&this.play("SILENCE")},this)};this._onerror=function(a){var b="",c;for(c in a)b+=a[c]+" ";logger.info("ERROR",
b)};this.canPlay=function(a){if(!this._map[a])return!1;var b=null;this.oneChannelOnly&&(b=this._map[a].end,a="AUDIO");a=this._audios[a];if(!a)return!1;if(a._ready||!b)return!0;try{var c=a.seekable.end();return b<=c}catch(d){return logger.log(d),!1}};this.play=function(a,b){if(!this.muted)if(void 0===b&&(b=1),this.canPlay(a)){var c=this._audios[this.oneChannelOnly?"AUDIO":a];try{c.paused||c.pause();var d=0;this.oneChannelOnly&&null!=this._map[a].start&&(d=this._map[a].start);c.currentTime!=d&&(c.currentTime=
d);c.volume=b;c.play();this._nowPlaying=this._map[a]}catch(e){}}else logger.info("Not ready yet")};this.pause=function(){_.each(this._audios,function(a){a.pause()},this)};this.playBackgroundMusic=function(a,b){if(!this.muted){if(this.oneChannelOnly)return!1;this._backgroundSoundPlaying=a;this.play(a,b)}};this.pauseBackgroundMusic=function(){this._backgroundSoundPlaying&&this._audios[this._backgroundSoundPlaying].pause()}});
