5bc325ba11863e6b9f2e4ce6e253d803
jsio("import ui.View as View");jsio("import ui.layout.Padding as Padding");jsio("import device");jsio("import .util.FragmentBuffer as FragmentBuffer");jsio("import .TextFlow");jsio("import ...legacySettings as legacySettings");
var messageFont=!0,sdk_timestep_ui_backend_canvas_TextView=__class__,TextView=exports=sdk_timestep_ui_backend_canvas_TextView(function(){return this.init&&this.init.apply(this,arguments)},View,function(f){var j={multiline:{replacement:"wrap"},textAlign:{replacement:"horizontalAlign"},lineWidth:{replacement:"strokeWidth"},strokeStyle:{replacement:"strokeColor"},outlineColor:{replacement:"strokeColor"}},k={wrap:!1,autoSize:!1,autoFontSize:!0,padding:new Padding(0),lineHeight:1.2,color:"#000000",fontFamily:device.defaultFontFamily,
fontWeight:"",size:12,strokeWidth:2,strokeColor:null,shadowColor:null,verticalAlign:"middle",horizontalAlign:"center",buffer:!0,backgroundColor:null},l={width:!0,height:!0,wrap:!0,autoSize:!0,autoFontSize:!0,padding:!0,lineHeight:!0,color:!1,fontFamily:!0,fontWeight:!0,size:!0,strokeWidth:!0,strokeColor:!1,shadowColor:!1,verticalAlign:!0,horizontalAlign:!0,backgroundColor:!1,text:!0},i=Object.keys(l),n=["width","height","size"],g=new FragmentBuffer;g.onGetHash=function(a){if(!a.hash){var b=i.length;
for(a.hash="";b;)a.hash+=a[i[--b]]||""}return a.hash};this.init=function(a){this._opts={};this._optsLast={};this._cacheUpdate=!0;this._textFlow=new TextFlow({target:this});this._textFlow.subscribe("ChangeWidth",this,"onChangeWidth");this._textFlow.subscribe("ChangeHeight",this,"onChangeHeight");this._textFlow.subscribe("ChangeSize",this,"onChangeSize");f(this,"init",[merge(a,k)])};this.onChangeWidth=function(a){this.updateOpts({width:a},!0)};this.onChangeHeight=function(a){this.updateOpts({height:a},
!0)};this.onChangeSize=function(a,b){this.updateOpts({size:a},!0);b&&(b.font=this._opts.fontWeight+" "+this._opts.size+"px "+this._opts.fontFamily)};this._restoreOpts=function(){for(var a=this._optsLast,b,c=n.length;c;)b=n[--c],b in a&&(this._opts[b]=a[b])};this._checkOpts=function(a){var b=this._optsLast,c,e=i.length;for(this._cacheUpdate=this._cacheUpdate||!Object.keys(this._opts).length;e;)c=i[--e],c in a&&(l[c]&&b[c]!==a[c])&&(this._cacheUpdate=!0),b[c]=c in a?a[c]:c in this._opts?this._opts[c]:
k[c]};this._checkDeprecatedOpts=function(a){a.allowVerticalSizing=!legacySettings.disableVerticalAutoSize;for(var b in j)if(b in a){var c=j[b];DEBUG&&!c.hasWarned&&(console.warn("TextView opts."+b+" is deprecated, please use "+c.replacement+"..."),c.hasWarned=!0);a[c.replacement]=a[b]}if(b=a.font){DEBUG&&messageFont&&(console.warn("TextView opts.font is deprecated, please use fontFamily and size..."),messageFont=!1);for(;b.length&&" "===b[0];)b=b.substr(1-b.length);c=b.indexOf(" ");-1!==c&&(a.size=
parseInt(b.substr(0,c).replace(/[pxtem\s]/gi,""),10),a.fontFamily=b.substr(c+1-b.length))}};this.updateOpts=function(a,b){this._checkDeprecatedOpts(a);"padding"in a&&(this.style.padding=new Padding(a.padding));if(!b)if(this._restoreOpts(),this._checkOpts(a),this._cacheUpdate)a.hash=!1;else{f(this,"updateOpts",arguments);return}a=f(this,"updateOpts",arguments);"text"in a&&this.setText(a.text);!b&&this._textFlow.setOpts(this._opts);return a};this._updateCtx=function(a){var b=this._opts;a.textAlign=
"left";a.textBaseline="top";a.fillStyle=b.color;a.font=b.fontWeight+" "+b.size+"px "+b.fontFamily;a.lineWidth=b.strokeWidth};this._renderToCtx=function(a,b,c){var e=this._opts,g=this._textFlow.getCache(),d=e.autoFontSize?this._textFlow.getActualWidth():1E6,h,i=e.color,f=e.strokeColor,j=e.shadowColor,k=e.strokeWidth/2,m,l=g.length;legacySettings.textViewColor&&this.color&&(i=this.color);this._updateCtx(a);f&&(a.strokeStyle=f);for(;l;)h=g[--l],e=h.word,m=b+h.x,h=c+h.y,f&&a.strokeText(e,m,h,d),j&&(a.fillStyle=
j,a.fillText(e,m+k,h+k,d)),a.fillStyle=i,a.fillText(e,m,h,d)};this._renderBuffer=function(a){var b=g.getContext(),c=this._textFlow.getOffsetRect(),e=c.width,f=c.height,d=this._textFlow.getCache();this._opts.lineCount=d[d.length-1].line;d=g.getPositionForText(this);null!=d?(this._cacheUpdate&&(b.clearRect(d.x,d.y,d.width,d.height),this._renderToCtx(b,d.x-c.x,d.y-c.y)),a.drawImage(g.getCanvas(),d.x,d.y,e,f,c.x,c.y,e,f)):this._opts.buffer=!1};this.render=function(a){var b=this._opts;this._cacheUpdate&&
(this._updateCtx(a),this._textFlow.reflow(a,1+(b.autoFontSize?4:0)+(b.autoSize?2:0)+(b.wrap?1:0)));this._textFlow.getCache().length&&(this._opts.buffer?this._renderBuffer(a):this._renderToCtx(a,0,0));this._cacheUpdate=!1};this.clearBuffers=function(){g.clearBuffer()};this.getFontBuffer=function(){return g};this.setText=function(a){this._restoreOpts();this._opts.text=void 0!=a?a.toString():"";this._cacheUpdate=!0;this.needsRepaint()};this.getText=function(){return this._opts.text};this.getTag=function(){return"TextView"+
this.uid+":"+(this.tag||this._opts.text.substring(0,20))};this.reflow=function(){this._restoreOpts();this._cacheUpdate=!0}});exports.clearBuffers=TextView.prototype.clearBuffers;exports.getFontBuffer=TextView.prototype.getFontBuffer;
