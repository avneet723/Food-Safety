6e9c5358b55fd16d88d2e2c51dc1505e
jsio("import ui.View as View");jsio("import ui.layout.Padding as Padding");jsio("import device");jsio("import .util.FragmentBuffer as FragmentBuffer");jsio("import .TextFlow");jsio("import ...legacySettings as legacySettings");
var messageFont=!0,sdk_timestep_ui_backend_canvas_TextView=__class__,TextView=exports=sdk_timestep_ui_backend_canvas_TextView(function(){return this.init&&this.init.apply(this,arguments)},View,function(g){var i={multiline:{replacement:"wrap"},textAlign:{replacement:"horizontalAlign"},lineWidth:{replacement:"strokeWidth"},strokeStyle:{replacement:"strokeColor"},outlineColor:{replacement:"strokeColor"}},j={wrap:!1,autoSize:!1,autoFontSize:!0,padding:new Padding(0),lineHeight:1.2,color:"#000000",fontFamily:device.defaultFontFamily,
fontWeight:"",size:12,strokeWidth:2,strokeColor:null,shadowColor:null,verticalAlign:"middle",horizontalAlign:"center",backgroundColor:null},k={width:!0,height:!0,wrap:!0,autoSize:!0,autoFontSize:!0,padding:!0,lineHeight:!0,color:!1,fontFamily:!0,fontWeight:!0,size:!0,strokeWidth:!0,strokeColor:!1,shadowColor:!1,verticalAlign:!0,horizontalAlign:!0,backgroundColor:!1,text:!0},h=Object.keys(k),n=["width","height","size"],e=new FragmentBuffer;e.onGetHash=function(a){if(!a.hash){var b=h.length;for(a.hash=
"";b;)a.hash+=a[h[--b]]||""}return a.hash};this.init=function(a){this._opts={};this._optsLast={};this._cacheUpdate=!0;this._textFlow=new TextFlow({target:this});this._textFlow.subscribe("ChangeWidth",this,"onChangeWidth");this._textFlow.subscribe("ChangeHeight",this,"onChangeHeight");this._textFlow.subscribe("ChangeSize",this,"onChangeSize");g(this,"init",[merge(a,j)])};this.onChangeWidth=function(a){this.updateOpts({width:a},!0)};this.onChangeHeight=function(a){this.updateOpts({height:a},!0)};this.onChangeSize=
function(a,b){this.updateOpts({size:a},!0);b&&(b.font=this._opts.fontWeight+" "+this._opts.size+"px "+this._opts.fontFamily)};this._restoreOpts=function(){for(var a=this._optsLast,b,c=n.length;c;)b=n[--c],b in a&&(this._opts[b]=a[b])};this._checkOpts=function(a){var b=this._optsLast,c,d=h.length;for(this._cacheUpdate=this._cacheUpdate||!Object.keys(this._opts).length;d;)c=h[--d],c in a&&(k[c]&&b[c]!==a[c])&&(this._cacheUpdate=!0),b[c]=c in a?a[c]:c in this._opts?this._opts[c]:j[c]};this._checkDeprecatedOpts=
function(a){a.allowVerticalSizing=!legacySettings.disableVerticalAutoSize;for(var b in i)if(b in a){var c=i[b];DEBUG&&!c.hasWarned&&(console.warn("TextView opts."+b+" is deprecated, please use "+c.replacement+"..."),c.hasWarned=!0);a[c.replacement]=a[b]}if(b=a.font){DEBUG&&messageFont&&(console.warn("TextView opts.font is deprecated, please use fontFamily and size..."),messageFont=!1);for(;b.length&&" "===b[0];)b=b.substr(1-b.length);c=b.indexOf(" ");-1!==c&&(a.size=parseInt(b.substr(0,c).replace(/[pxtem\s]/gi,
""),10),a.fontFamily=b.substr(c+1-b.length))}};this.updateOpts=function(a,b){this._checkDeprecatedOpts(a);"padding"in a&&(this.style.padding=new Padding(a.padding));if(!b)if(this._restoreOpts(),this._checkOpts(a),this._cacheUpdate)a.hash=!1;else{g(this,"updateOpts",arguments);return}a=g(this,"updateOpts",arguments);"text"in a&&this.setText(a.text);!b&&this._textFlow.setOpts(this._opts);return a};this._updateCtx=function(a){var b=this._opts;a.textAlign="left";a.textBaseline="top";a.fillStyle=b.color;
a.font=b.fontWeight+" "+b.size+"px "+b.fontFamily;a.lineWidth=b.strokeWidth};this._renderToCtx=function(a,b,c){var d=this._opts,e=this._textFlow.getCache(),m=d.autoFontSize?this._textFlow.getActualWidth():1E6,f,h=d.color,g=d.strokeColor,i=d.shadowColor,j=d.strokeWidth/2,l,k=e.length;legacySettings.textViewColor&&this.color&&(h=this.color);this._updateCtx(a);g&&(a.strokeStyle=g);for(;k;)f=e[--k],d=f.word,l=b+f.x,f=c+f.y,g&&a.strokeText(d,l,f,m),i&&(a.fillStyle=i,a.fillText(d,l+j,f+j,m)),a.fillStyle=
h,a.fillText(d,l,f,m)};this._renderBuffer=function(a){var b=this._opts,c=e.getContext(),d=this._textFlow.getOffsetRect(),g=d.width,h=d.height,f=this._textFlow.getCache();b.lineCount=f[f.length-1].line;b=e.getPositionForText(b);null!=b?(this._cacheUpdate&&this._renderToCtx(c,b.x-d.x,b.y-d.y),a.drawImage(e.getCanvas(),b.x,b.y,g,h,d.x,d.y,g,h)):this._opts.buffered=!1};this.render=function(a){var b=this._opts;this._cacheUpdate&&(this._updateCtx(a),this._textFlow.reflow(a,1+(b.autoFontSize?4:0)+(b.autoSize?
2:0)+(b.wrap?1:0)));this._textFlow.getCache().length&&(this._opts.buffer&&null!==e?this._renderBuffer(a):this._renderToCtx(a,0,0));this._cacheUpdate=!1};this.clearBuffers=function(){var a;null!==e&&(a=e.getContext(),a.clear(),a.globalCompositeOperation="source-over",e.clearBuffer())};this.getFontBuffer=function(){return e};this.setText=function(a){this._restoreOpts();this._opts.text=void 0!=a?a.toString():"";this._cacheUpdate=!0;this.needsRepaint()};this.getText=function(){return this._opts.text};
this.getTag=function(){return"TextView"+this.uid+":"+(this._lines&&this._lines.join(" ").substring(0,20))};this.reflow=function(){this._restoreOpts();this._cacheUpdate=!0}});exports.clearBuffers=TextView.prototype.clearBuffers;exports.getFontBuffer=TextView.prototype.getFontBuffer;
