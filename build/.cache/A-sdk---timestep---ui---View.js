e3ed8749a0cdf184a7bd658cad1cedd3
jsio("import device");jsio("import event.Emitter as Emitter");jsio("import math.geom.Point as Point");jsio("import math.geom.Rect as Rect");jsio("import .backend.canvas.ViewBacking");jsio("import ui.backend.ReflowManager as ReflowManager");var _reflowMgr=ReflowManager.get();jsio("import event.input.dispatch as dispatch");jsio("import event.input.InputHandler as InputHandler");jsio("import animate");jsio("import util.setProperty");
var KeyListener=device.get("KeyListener"),EventScheduler=__class__,EventScheduler=EventScheduler(function(){return this.init&&this.init.apply(this,arguments)},function(){this.init=function(){this._queue=[]};this.add=function(a){this._queue.push(a);if(!this._running){for(this._running=!0;a=this._queue.shift();)a();this._running=!1}}}),scheduler=new EventScheduler,FocusMgr=new (Class(function(){this.init=function(){this._keyListener=KeyListener&&new KeyListener;this._target=null;this._canChange=!0};
this.focus=function(a){if(this._target!=a&&this._canChange){if(this._target&&this._target.onBlur)this._target.onBlur(this);if((this._target=a)&&a.onFocus)this._target.onFocus(this)}};this.blur=function(a){a.onBlur&&a.onBlur(this);this._target=!1};this.getKeyListener=function(){return this._keyListener};this.get=function(){return this}})),UID=0,_BackingCtor=null,sdk_timestep_ui_View=__class__,View=exports=sdk_timestep_ui_View(function(){return this.init&&this.init.apply(this,arguments)},Emitter,function(){this.init=
function(a){a||(a={});this.uid=++UID;this.__input=new InputHandler(this,a);this.__view=this.style=new (a.Backing||_BackingCtor)(this,a);this._filters={};this.__view._view=this;this.updateOpts(a)};this.updateOpts=function(a){a=a||{};if(this._opts)for(var b in a)this._opts[b]=a[b];else this._opts=a;a.tag&&(this.tag=a.tag);a.filters&&(this._filters=a.filters);a.infinite&&(this._infinite=a.infinite);this.style.update(a);a.superview&&a.superview.addSubview(this);a.parent&&a.parent.addSubview(this);return a};
this.getFilters=function(){return this._filters};this.addFilter=function(a){this._filters[a.getType()]=a};this.removeFilter=function(a){delete this._filters[a]};util.setProperty(this,"render",{value:void 0,cb:function(){this.__view&&(this.__view.hasJSRender=!0)}});util.setProperty(this,"tick",{value:void 0,cb:function(){this.__view&&(this.__view.hasJSTick=!0)}});this.getAnimation=function(a){return animate(this,a)};this.animate=function(a,b,c){return this.getAnimation().then(a,b,c)};this.focus=function(){FocusMgr.get().focus(this);
return this};this.blur=function(){FocusMgr.get().blur(this);return this};this.onFocus=function(){this._isFocused=!0};this.onBlur=function(){this._isFocused=!1};this.isDragging=function(){return this.__input.isDragging()};this.startDrag=function(a){this.__input.startDrag(a)};this.getInput=function(){return this.__input};this.isInputOver=function(){return!!this.__input.overCount};this.getInputOverCount=function(){return this._inputOverCount};this.setHandleEvents=this.canHandleEvents=function(a,b){this.__input.canHandleEvents=
a;"boolean"===typeof ignoreEvents&&(this.__input.blockEvents=b)};this.setIsHandlingEvents=function(a){this.__input.canHandleEvents=a};this.isHandlingEvents=function(){return this.__input.canHandleEvents};this.needsRepaint=function(){this._needsRepaint=!0};this.needsReflow=function(a){if(this.style.__firstRender||a)_reflowMgr.add(this),this._needsRepaint=!0};this._onEventPropagate=function(a,b,c){if(c){var b=a.id,f;switch(a.type){case dispatch.eventTypes.SELECT:case dispatch.eventTypes.CLEAR:dispatch._evtHistory[dispatch.eventTypes.MOVE]=
null;(c=dispatch._activeInputOver[b])&&dispatch.clearOverState(b);break;case dispatch.eventTypes.START:case dispatch.eventTypes.MOVE:var d=a.trace[0],e=null;if((c=dispatch._activeInputOver[b])&&d!=c.trace[0]){var g=c.trace;for(f=0;e=g[f];++f)if(!(e.uid in a.pt))e.__input.onLeave(b,d==e)}if(!c||d!=c.trace[0]){g=a.trace;for(f=a.depth-1;0<=f;--f)g[f].__input.onEnter(b,d==e);dispatch._activeInputOver[b]=a}}}};this.localizePoint=function(a){var b=this.getParents(),c=0;for(b.push(this);b[++c];)a=b[c].__view.localizePoint(a);
return a};this.getSubview=function(a){return this.__view.getSubviews()[a]};this.getSubviews=function(){return this.__view.getSubviews()};this.getSuperview=function(){return this.__view.getSuperview()};this.connectEvent=function(a,b){this.__subs||(this.__subs=[],this.on("ViewAdded",bind(this,"_connectEvents")),this.on("ViewRemoved",bind(this,"_disconnectEvents")),this.__root&&this._connectEvents());var c=Array.prototype.slice.call(arguments,1);this.__subs.push([a,c]);this.__root&&a.on.apply(a,c)};
this.disconnectEvent=function(a,b){if(this.__subs)for(var c=Array.prototype.slice.call(arguments,1),f=0,d;d=this.__subs[f];++f){var e;if(e=d[0]==a)a:{e=0;for(var g=c.length;e<g;++e)if(c[e]!=d[1][e]){e=!1;break a}e=!0}e&&(d[0].removeListener.apply(d[0],d[1]),this.__subs.splice(f--,1))}};this._connectEvents=function(){for(var a=0,b;b=this.__subs[a];++a)b[0].on.apply(b[0],b[1])};this._disconnectEvents=function(){for(var a=0,b;b=this.__subs[a];++a)b[0].removeListener.apply(b[0],b[1])};this.addSubview=
function(a){if(this.__view.addSubview(a)&&(a.needsRepaint(),a.needsReflow(),a.__input.resetOver(),this.publish("SubviewAdded",a),this.__root)){var b=this.__root;scheduler.add(bind(this,function f(d){d.__root=b;d.emit("ViewAdded",a);for(var d=d.getSubviews(),e=0,g;g=d[e];++e)f(g)},a))}return a};this.removeSubview=function(a){this.__view.removeSubview(a)&&(this.publish("SubviewRemoved",a),a.__root&&scheduler.add(bind(this,function c(a){a.__root=null;a.emit("ViewRemoved",this);for(var a=a.getSubviews(),
d=0,e;e=a[d];++d)c(e)},a)));return a};this.removeFromSuperview=function(){var a=this.__view.getSuperview();a&&a.removeSubview(this)};this.removeAllSubviews=function(){for(var a=this.getSubviews(),b=a.length;b--;)this.removeSubview(a[b])};util.setProperty(this,"_superview",{get:this.getSuperview,set:function(){}});util.setProperty(this,"_subviews",{get:this.getSubviews,set:function(){}});this.reflow=function(){};this.getApp=function(){var a=this,b;do b=a.__view.getSuperview();while(b&&(a=b));return a.__root};
this.getParents=function(){var a=[this],b;do b=a[0].__view.getSuperview();while(b&&a.unshift(b));a.pop();return a};this.buildView=function(){};this.containsLocalPoint=function(a){if(this._infinite)return!0;var b=this.style,c=b.width,b=b.height;return 0<c&&0<b?a.x<=c&&a.y<=b&&0<=a.x&&0<=a.y:0<c?a.x<=c&&a.y>=b&&0<=a.x&&0>=a.y:0<b?a.x>=c&&a.y<=b&&0>=a.x&&0<=a.y:a.x>=c&&a.y>=b&&0>=a.x&&0>=a.y};this.getBoundingShape=function(){var a=this.style;return this._infinite?!0:new Rect(a.x,a.y,a.width*a.scale,
a.height*a.scale)};this.getRelativeRegion=function(a,b){var c=this.getPosition(b||a.src);return new Rect((a.x-c.x)/c.scale,(a.y-c.y)/c.scale,a.width/c.scale,a.height/c.scale)};this.getPosition=function(a){for(var b=new Point,c=this,f=0,d=this.style,e=d.width,d=d.height,g=1;c&&c!=a;){var h=c.style.scale;b.add(-c.style.anchorX,-c.style.anchorY);b.rotate(c.style.r);b.scale(h);b.add(c.style.anchorX+c.style.x+c.style.offsetX,c.style.anchorY+c.style.y+c.style.offsetY);f+=c.style.r;e*=h;d*=h;g*=h;c=c.__view.getSuperview()}return{x:b.x,
y:b.y,r:f%(2*Math.PI),width:e,height:d,scale:g,anchorX:this.style.anchorX,anchorY:this.style.anchorY}};this.getBacking=function(){return this.__view};this.show=function(){this.style.visible=!0;this.needsRepaint()};this.hide=function(){this.style.visible=!1;this.needsRepaint()};this.toString=this.getTag=function(){var a="View";DEBUG&&(this.__tagClassName?a=this.__tagClassName:((a=this.constructor.name)||(a=this.constructor.toString().match(/^function ([^(]+)/)[1]),a&&(a=a.substr(a.lastIndexOf("_")+
1)),this.__tagClassName=a||"unknown"));return a+this.uid+(this.tag?":"+this.tag:"")}}),_extensions=[];View.addExtension=function(a){a.extend(View.BackingCtor);_extensions.push(a)};View.setDefaultViewBacking=function(a){_BackingCtor=View.BackingCtor=a;_extensions.forEach(function(a){a.extend(_BackingCtor)})};View.setDefaultViewBacking(backend.canvas.ViewBacking);
