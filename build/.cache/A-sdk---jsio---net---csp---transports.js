9d107ad1620655931f9f47b756cb27fd
jsio("import std.uri as uri");jsio("import std.base64 as base64");jsio("from util.browserdetect import BrowserDetect");
(function(){var a;exports.getDoc=function(){if(a)return a;try{if(a=window.ActiveXObject&&new ActiveXObject("htmlfile"))a.open().write("<html></html>"),a.close(),window.attachEvent("onunload",function(){try{a.body.innerHTML=""}catch(b){}a=null})}catch(b){}a||(a=document);return a};exports.XHR=function(){var a=window;exports.getDoc();return new (exports.XHR=a.XMLHttpRequest?a.XMLHttpRequest:function(){return a.ActiveXObject&&new a.ActiveXObject("Msxml2.XMLHTTP")||null})};exports.createXHR=function(){return new exports.XHR}})();
function isLocalFile(a){return/^file:\/\//.test(a)}function isWindowDomain(a){return uri.isSameDomain(a,window.location.href)}var xhrSupportsBinary=void 0;function checkXHRBinarySupport(a){xhrSupportsBinary=!!a.sendAsBinary}
function canUseXHR(a){if(isLocalFile(a))return!1;var b=new exports.XHR;if(!b)return!1;checkXHRBinarySupport(b);if(isWindowDomain(a)||window.XMLHttpRequest&&(b.__proto__==XMLHttpRequest.prototype||b instanceof window.XMLHttpRequest)&&void 0!==b.withCredentials||window.XDomainRequest&&b instanceof window.XDomainRequest)return!0}var transports=exports.transports={};
exports.chooseTransport=function(a,b){switch(b.preferredTransport){case "jsonp":return transports.jsonp;default:return canUseXHR(a)?transports.xhr:transports.jsonp}};var PARAMS={xhrstream:{is:"1",bs:"\n"},xhrpoll:{du:"0"},xhrlongpoll:{},sselongpoll:{bp:"data: ",bs:"\r\n",se:"1"},ssestream:{bp:"data: ",bs:"\r\n",se:"1",is:"1"}};exports.Transport=__class__;
exports.Transport=exports.Transport(function(){return this.init&&this.init.apply(this,arguments)},function(){this.handshake=function(){throw Error("handshake Not Implemented");};this.comet=function(){throw Error("comet Not Implemented");};this.send=function(){throw Error("send Not Implemented");};this.encodePacket=function(){throw Error("encodePacket Not Implemented");};this.abort=function(){throw Error("abort Not Implemented");}});
var baseTransport=__class__,baseTransport=baseTransport(function(){return this.init&&this.init.apply(this,arguments)},exports.Transport,function(){this.init=function(){this._aborted=!1;this._handshakeArgs={ct:"application/javascript"};this._handshakeData="{}"};this.handshake=function(a,b){logger.debug("handshake:",a,b);this._makeRequest("send",a+"/handshake",this._handshakeArgs,this._handshakeData,this.handshakeSuccess,this.handshakeFailure)};this.comet=function(a,b,j,h){logger.debug("comet:",a,b,
j,h);this._makeRequest("comet",a+"/comet",{s:b,a:j},null,this.cometSuccess,this.cometFailure)};this.send=function(a,b,j,h){this._makeRequest("send",a+"/send",{s:b,a:j},h,this.sendSuccess,this.sendFailure)}});transports.xhr=__class__;
transports.xhr=transports.xhr(function(){return this.init&&this.init.apply(this,arguments)},baseTransport,function(a){function b(a,b,c,i){try{var f={status:a.status}}catch(g){i({response:"Could not access status"})}try{if(4!=a.readyState)return;f.response=eval(a.responseText);if(200!=f.status){logger.debug("XHR failed with status ",a.status);i(f);return}logger.debug("XHR data received")}catch(d){logger.debug("Error in XHR::onReadyStateChange",d);i(f);this._abortXHR(b);logger.debug("done handling XHR error");
return}c(f)}this.init=function(){a(this,"init");this._xhr={send:new exports.XHR,comet:new exports.XHR}};this.abort=function(){this._aborted=!0;for(var a in this._xhr)this._xhr.hasOwnProperty(a)&&this._abortXHR(a)};this._abortXHR=function(a){logger.debug("aborting XHR");var b=this._xhr[a];try{"onload"in b?b.onload=b.onerror=b.ontimeout=null:"onreadystatechange"in b&&(b.onreadystatechange=null),b.abort&&b.abort()}catch(c){logger.debug("error aborting xhr",c)}this._xhr[a]=new exports.XHR};this.encodePacket=
function(a,b){return!xhrSupportsBinary?[a,1,base64.encode(b)]:[a,0,b]};this._makeRequest=function(a,h,c,i,f,g){if(!this._aborted){var d=this._xhr[a];d.open("POST",h+"?"+uri.buildQuery(c));d.setRequestHeader("Content-Type","text/plain");"onload"in d?(d.onload=bind(this,b,d,a,f,g),d.onerror=d.ontimeout=g):"onreadystatechange"in d&&(d.onreadystatechange=bind(this,b,d,a,f,g));setTimeout(function(){d[xhrSupportsBinary?"sendAsBinary":"send"](i||null)},0)}}});var EMPTY_FUNCTION=function(){},SLICE=Array.prototype.slice;
transports.jsonp=__class__;
transports.jsonp=transports.jsonp(function(){return this.init&&this.init.apply(this,arguments)},baseTransport,function(a){function b(d,a){logger.debug("successful: ",d.url,a);d.completed=!0;logger.debug("calling the cb");d.cb.call(GLOBAL,{status:200,response:a});logger.debug("cb called")}function j(d,a){a&&"loaded"!=a.readyState||(a.onreadystatechange=function(){},h.call(this,d))}function h(d,a){i(this._ifr[d.type]);if(!d.completed){var b={status:a?200:404,response:a||"Unable to load resouce"};logger.debug("error making request:",
d.url,b);logger.debug("calling eb");d.eb.call(GLOBAL,b)}}var c=function(){var a=exports.getDoc();if(!a.body)return!1;var b=a.createElement("iframe");with(b.style)display="block",width=height=border=margin=padding="0",overflow=visibility="hidden",position="absolute",top=left="-999px";b.cbId=0;a.body.appendChild(b);b.src="about:blank";return b},i=function(a){var b=a.contentWindow,e=b.document;logger.debug("removing script tags");for(var f=e.getElementsByTagName("script"),g=f.length-1;0<=g;--g)e.body.removeChild(f[g]);
logger.debug("deleting iframe callbacks");b["cb"+a.cbId]=b["eb"+a.cbId]=EMPTY_FUNCTION},f=function(a){setTimeout(function(){a&&a.parentNode&&a.parentNode.removeChild(a)},6E4)};this.init=function(){a(this,"init");this._onReady=[];this._isReady=!1;this._createIframes()};this._createIframes=function(){this._ifr={send:c(),comet:c()};if(!1===this._ifr.send)return setTimeout(bind(this,"_createIframes"),100);this._isReady=!0;var a=this._onReady;this._onReady=[];for(var b=0,e;e=a[b];++b)this._makeRequest.apply(this,
e)};this.encodePacket=function(a,b){return[a,1,base64.encode(b)]};this.abort=function(){this._aborted=!0;for(var a in this._ifr)if(this._ifr.hasOwnProperty(a)){var b=this._ifr[a];i(b);f(b)}};this._makeRequest=function(a,b,e,g,f,h){if(!this._isReady)return this._onReady.push(arguments);var c=++this._ifr[a].cbId,c={type:a,id:c,cb:f,eb:h,cbName:"cb"+c,ebName:"eb"+c,completed:!1};e.d=g;e.n=Math.random();switch(a){case "send":e.rs=";";e.rp=c.cbName;break;case "comet":e.bs=";",e.bp=c.cbName}c.url=b+"?"+
uri.buildQuery(e);setTimeout(bind(this,"_request",c),0)};this._request=function(a){var c=this._ifr[a.type].contentWindow,e=c.document,f=e.body;if(!f)return setTimeout(bind(this,"_request",a),100);c[a.ebName]=bind(this,h,a);c[a.cbName]=bind(this,b,a);if(BrowserDetect.isWebKit)e.open(),e.write('<script src="'+a.url+'"><\/script><script>'+ebName+"(false)<\/script>"),e.close();else if(c=e.createElement("script"),c.src=a.url,null===c.onreadystatechange&&(c.onreadystatechange=bind(this,j,a,c)),f.appendChild(c),
!BrowserDetect.isIE)c=e.createElement("script"),c.innerHTML=a.ebName+"(false)",f.appendChild(c);g()};var g=BrowserDetect.isFirefox||BrowserDetect.isOpera?function(){var a=document.body;a&&(g.iframe||(g.iframe=document.createElement("iframe")),a.insertBefore(g.iframe,a.firstChild),a.removeChild(g.iframe))}:function(){}});
