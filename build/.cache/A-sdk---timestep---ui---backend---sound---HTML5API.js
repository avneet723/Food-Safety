ab6017607b4f80d152afda008acb59fa
jsio("import event.Emitter as Emitter");jsio("import util.path");jsio("import device");
var RawAudio=__class__,RawAudio=RawAudio(function(){return this.init&&this.init.apply(this,arguments)},function(){this.init=function(){var c=new Audio,a=RawAudio.prototype,b;for(b in a)!c[b]&&a.hasOwnProperty(b)&&(c[b]=RawAudio.prototype[b]);GLOBAL.ACCESSIBILITY.subscribe("MuteChange",this,function(){c.muted=GLOBAL.ACCESSIBILITY.muted});c.muted=GLOBAL.ACCESSIBILITY.muted;return c};this.stop=function(){try{if(this.paused||this.pause(),(!("NETWORK_LOADING"in this)||this.networkState!=this.NETWORK_LOADING||
this.networkState!=this.NETWORK_NO_SOURCE)&&!isNaN(this.duration))this.currentTime=0}catch(c){}}}),MultiSound=__class__,MultiSound=MultiSound(function(){return this.init&&this.init.apply(this,arguments)},function(){this.init=function(c,a,b){this._soundManager=c;this._name=a;for(var b="string"==typeof b?{sources:[b]}:b||{},a=b.sources||[a],i=this._sources=[],j=c.getPath(),f=c.getExt(),k=RegExp(f+"$","i"),g=b.loop||b.background,l=void 0!==b.volume?b.volume:1,h=0,d;d=a[h];++h){d=util.path.join(j,b.path,
d);k.test(d)||(d+=f);var e=new RawAudio;e.loop=g;e.volume=l;e.isBackgroundMusic=b.background;e.src=d;e.preload=c._preload&&!b.background?"auto":"none";i.push(e)}this.loop=g;this.isBackgroundMusic=b.background};this.setVolume=function(c){for(var a=0,b;b=this._sources[a];++a)b.volume=c};this.stop=function(){for(var c=0,a;a=this._sources[c];++c)a.stop()};this.pause=function(){this._isPaused=!0;for(var c=0,a;a=this._sources[c];++c)a.pause()};this.play=function(c){c=c||{};this._isPaused?this._isPaused=
!1:this.stop();var a=this._getRandom();a.loop=c.loop||this.loop;a.play();a.muted&&(a.muted=!1,a.muted=!0)};this._getRandom=function(){return this._sources[Math.random()*this._sources.length|0]}}),sdk_timestep_ui_backend_sound_HTML5API=__class__;
exports=sdk_timestep_ui_backend_sound_HTML5API(function(){return this.init&&this.init.apply(this,arguments)},Emitter,function(c){this.init=function(a){a=a||{};c(this,"init",[a]);this.setPath(a.path);this._map=a.files||a.map;this._preload=a.preload;this._sounds={};this._areEffectsMuted=this._isMusicMuted=!1;this._currentMusic=null;a.persist&&this.persistState(a.persist);a=new Audio;this._ext=a.canPlayType("audio/mpeg")?".mp3":a.canPlayType("audio/ogg")?".ogg":"";this._ext||(this._ext=".mp3",logger.log("warning: could not determine sound support type"));
for(var b in this._map)this.addSound(b,this._map[b])};this.getExt=function(){return this._ext};this.getPath=function(a){return a?this._sounds[a].path:this._path};this.setPath=function(a){a&&(a=a.replace(/\/$/,""));this._path=a||""};this.addSound=function(a,b){this._sounds[a]=new MultiSound(this,a,b)};this.persistState=function(a){this._key=a;if(a=localStorage.getItem(this._key))try{a=JSON.parse(a)}catch(b){}a&&(logger.log("restoring audio api state"),this.setMusicMuted(a.isMusicMuted),this.setEffectsMuted(a.areEffectsMuted))};
this._persist=function(){this._key&&localStorage.setItem(this._key,JSON.stringify({isMusicMuted:this._isMusicMuted,areEffectsMuted:this._areEffectsMuted}))};this.getMuted=function(){return this._isMusicMuted&&this._areEffectsMuted};this.getMusicMuted=function(){return this._isMusicMuted};this.getEffectsMuted=function(){return this._areEffectsMuted};this.setMuted=function(a){this.setMusicMuted(a);this.setEffectsMuted(a)};this.setMusicMuted=function(a){a!=this._isMusicMuted&&(this._isMusicMuted=a,this._persist(),
this._currentMusic&&(a?this._currentMusic.pause():this._currentMusic.play()))};this.setEffectsMuted=function(a){if(a!=this._areEffectsMuted&&(this._areEffectsMuted=a,this._persist(),a))for(var b in this._sounds)a=this._sounds[b],a.isBackgroundMusic||a.stop()};this.setVolume=function(a,b){var c=this._sounds[a];return c?(c.setVolume(b),!0):!1};this.getVolume=function(a){return(a=this._sounds[a])?Math.round(10*a._sources[0].volume)/10:null};this.play=function(a,b){var c=this._sounds[a],b=b||{};if(!c)return logger.log("warning: no sound of that name"),
!1;c.isBackgroundMusic?(this._currentMusic&&this._currentMusic.stop(),this._currentMusic=c,this._isMusicMuted||c.play(b)):this._areEffectsMuted||c.play(b);return!0};this.pause=function(a){a=this._sounds[a];if(!a)return!1;this._currentMusic==a&&(this._currentMusic=null);a.pause();return!0};this.stop=function(a){a=this._sounds[a];if(!a)return!1;this._currentMusic==a&&(this._currentMusic=null);a.stop();return!0};this.playBackgroundMusic=this.play;this.pauseBackgroundMusic=function(){this._currentMusic&&
this._currentMusic.pause()}});
