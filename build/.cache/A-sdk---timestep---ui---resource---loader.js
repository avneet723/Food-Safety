2883e8185ca9bd199223567ec85d18f8
jsio("import lib.Callback");
var _cache={},MIME={".png":"image",".jpg":"image",".bmp":"image",".css":"css",".html":"html",".mp3":"audio",".ogg":"audio",".mp4":"audio",".3gp":"audio",".m4a":"audio",".aac":"audio",".flac":"audio",".mkv":"audio",".wav":"audio"},Loader=__class__,Loader=Loader(function(){return this.init&&this.init.apply(this,arguments)},function(){this._map={};this.getMap=function(){return this._map};this.setMap=function(a){this._map=a||{}};this.get=function(a){return"resources/images/"+a};this.preload=function(a,
d,c){"function"==typeof d&&(c=d,d=void 0);if(isArray(a)){var e=new lib.Callback;a.forEach(function(a){a&&this.preload(a,d,e.chain())},this);c&&e.run(c);return e}var a=a.replace(/^\//,""),f={},h=this._map,b;for(b in h)0==b.indexOf(a)&&(f[h[b]&&h[b].sheet||b]=!0);a=Object.keys(f);a=this._loadGroup(merge({resources:a},d));c&&a.run(c);return a};var j=null;this.getSound=function(a){j||(jsio("import AudioManager"),j=new AudioManager);if(GLOBAL.NATIVE&&GLOBAL.NATIVE.sound&&GLOBAL.NATIVE.sound.preloadSound)return NATIVE.sound.preloadSound(a);
j.addSound(a);return{complete:!0}};this.getImage=function(a,d){var c=new Image;if(Image.get){var e=Image.get(a);if(e instanceof Image)return e}e?(c.src=e,Image.set(a,c)):(d||logger.warn(a,"may not be properly cached!"),c.src=a);return c};this._updateImageMap=function(a,d,c,e,f,h){var c=c||0,e=e||0,f=void 0==f?-1:f,h=void 0==h?-1:h,b=this._map[d];if(!b||!b.sheet)a.x=c,a.y=e,a.width=f,a.height=h,a.scale=1,a.url=d;else return d=b.scale||1,a.x=b.x-b.marginLeft,a.y=b.y-b.marginTop,a.width=b.w+b.marginLeft+
b.marginRight,a.height=b.h+b.marginTop+b.marginBottom,a.x+=c*d,a.y+=e*d,0<f&&(a.width=f*d),0<h&&(a.height=h*d),a.marginLeft=Math.max(0,b.x-a.x),a.marginTop=Math.max(0,b.y-a.y),a.marginRight=Math.max(0,a.x+a.width-(b.x+b.w)),a.marginBottom=Math.max(0,a.y+a.height-(b.y+b.h)),a.x+=a.marginLeft,a.y+=a.marginTop,a.width-=a.marginLeft+a.marginRight,a.height-=a.marginTop+a.marginBottom,a.scale=d,a.url=b.sheet,a};this._getRaw=function(a,d,c,e){if(!c&&_cache[d])return _cache[d];c=null;switch(a){case "audio":c=
this.getSound(d);break;case "image":c=this.getImage(d,e);break;default:logger.error("unknown type for preloader",a)}return _cache[d]=c};this._loadGroup=function(a,d){for(var c=a.timeout,e=new lib.Callback,f=a.resources||[],h=f.length||0,b=[],i=0;i<h;++i){var j=f[i].substring(f[i].lastIndexOf(".")).split("|")[0];"image"==MIME[j]?(b.push({type:"image",resource:f[i]}),GLOBAL.NATIVE&&NATIVE.gl&&NATIVE.gl.touchTexture(f[i])):"audio"==MIME[j]&&b.push({type:"audio",resource:f[i]})}if(!b.length)return d&&
e.run(d),e.fire(),e;var o=0,l=b.length,p=a.parallel||5,k=0,n=bind(this,function(){var a=o++,c=b[a],g;if(c){g=this._getRaw(c.type,c.resource,!1,!0);var f=function(a){k>=l||(g.onreload=g.onload=g.onerror=function(){},++k,k>=l?(d&&d(c,a,!0,k,l),m&&clearTimeout(m),e.fire()):(d&&d(c,a,!1,k,l),setTimeout(n,0)))};if(g.reload&&g.complete){var h=g.onreload,i=g.onerror;g.onreload=function(){h&&h();f(!1)};g.onerror=function(){i&&i();f(!0)};g.reload()}else g.complete?f(!0===g.failed):(h=g.onload,i=g.onerror,
g.onload=function(){h&&h();g.failed=!1;f(!1)},g.onerror=function(){i&&i();g.failed=!0;f(!0)})}}),m=null;setTimeout(function(){for(var a=0;a<p;++a)n();c&&(m=setTimeout(function(){e.fire();k=l},c))},0);return e}});exports=new Loader;
