b05f5fe3879513a8fe8f7b43c30621f9
jsio("import device");jsio("import event.Callback as Callback");jsio("import animate");jsio("import animate.transitions as transitions");jsio("import event.input.InputEvent as InputEvent");jsio("import math.geom.Point as Point");jsio("from util.browser import $");jsio("import ..BaseBacking");
var Canvas=device.get("Canvas"),AVOID_CSS_ANIM=device.isAndroid,sdk_timestep_ui_backend_dom_ViewBacking=__class__,ViewBacking=exports=sdk_timestep_ui_backend_dom_ViewBacking(function(){return this.init&&this.init.apply(this,arguments)},BaseBacking,function(){var k={};"x y r width height visible anchorX anchorY opacity scale zIndex scrollLeft scrollTop flipX flipY".split(" ").forEach(function(a){k[a]=!0;this.__defineGetter__(a,function(){return a in this._computed?this._computed[a]:parseInt(this._node.style[a])});
this.__defineSetter__(a,function(b){var c={};c[a]=b;this._setProps(c);return b})},this);this.init=function(a,b){this._view=a;this._subviews=[];var c=this._node=document.createElement(b.elementType||"div");c._view=a;c.addEventListener("webkitTransitionEnd",bind(this,"_transitionEnd"),!1);c.className="view "+b.className;c=c.style;c.fontSize="1px";c.position="absolute";c.top="0px";c.left="0px";device.isAndroid||(c.webkitBackfaceVisibility="hidden");c.webkitTransformOrigin="0px 0px";for(var d in b.styles)c[d]=
b.styles[d];this._computed={x:0,y:0,r:0,width:void 0,height:void 0,anchorX:0,anchorY:0,opacity:1,visible:!0,zIndex:0,scale:1};this._animating=!1;this._animationQueue=[];this._animationCallback=null};this.getElement=function(){return this._node};var l=9E5;this.addSubview=function(a){var b=a.__view,c=b._node,d=c.parentNode&&c.parentNode._view;if(d==this._view)return!1;d&&d.__view.removeSubview(a);d=this._subviews.length;this._subviews[d]=a;this._node.appendChild(c);b._setAddedAt(++l);d&&b.__sortKey<
this._subviews[d-1].__view.__sortKey&&(this._needsSort=!0);return!0};this.removeSubview=function(a){var b=this._subviews.indexOf(a);return-1!=b?(this._subviews.splice(b,1),this._node.removeChild(a.__view._node),!0):!1};this.getSuperview=function(){var a=this._node.parentNode;return a==document.body||!a?null:a._view};this.getSubviews=function(){this._needsSort&&(this._needsSort=!1,this._subviews.sort());return this._subviews};this.wrapTick=function(a,b){this._view.tick&&this._view.tick(a,b);for(var c=
0,d;d=this._subviews[c];++c)d.__view.wrapTick(a,b)};this.wrapRender=function(a,b){if(this.visible){this.__firstRender||this._view.needsReflow(!0);this._needsSort&&(this._needsSort=!1,this._subviews.sort());var c=this._computed.width,d=this._computed.height;if(c&&d&&!(0>c||0>d))try{var h=this._view.render;if(h&&!h.isFake){this._canvas||(this._canvas=new Canvas,this._node.insertBefore(this._canvas,this._node.firstChild),this.ctx=this._canvas.getContext("2d"));var j=this._view._needsRepaint;if((c|0)!=
this._canvas.width||(d|0)!=this._canvas.height)j=!0,this._canvas.width=c,this._canvas.height=d;j&&(this._view._needsRepaint=!1,this._canvas.style.display="none",this.ctx.clear(),this.ctx.save(),h.call(this._view,this.ctx,b),this.ctx.restore(),this._canvas.style.display="block")}this._renderSubviews(a,b)}catch(i){logger.error(this,i.message,i.stack)}}};this._renderSubviews=function(a,b){for(var c=0,d,h=this._subviews;d=h[c++];)d.__view.wrapRender(a,b)};this.localizePoint=function(a){var b=this._computed;
a.x-=b.x+b.anchorX;a.y-=b.y+b.anchorY;b.r&&a.rotate(-b.r);a.scale(1/b.scale);a.x+=b.anchorX;a.y+=b.anchorY;return a};this.copy=function(){return merge({},this._computed)};this.update=function(a){this._setProps(a)};this._updateOrigin=function(){this._node.style.webkitTransformOrigin=this._circle?"50% 50%":(this._computed.anchorX||0)+"px "+(this._computed.anchorY||0)+"px"};this._onPosition=function(){this._setMatrix()};this._onResize=function(){this._setMatrix();this._setCenter();this._view.needsReflow()};
this._setProps=function(a,b){var c=!1,d=this._node.style,h=0,j=!1,i={},e;for(e in a){var f=a[e];if("dx"==e||"dy"==e)e=e.substr(1),f=this._computed[e]+f;switch(e){case "circle":this._circle=f;this._setCenter();this._updateOrigin();break;case "anchorX":case "anchorY":this._computed[e]=f;this._updateOrigin();break;case "clip":this._computed.clip=f;d.overflow=f?"hidden":"visible";break;case "zIndex":this._computed.zIndex!=f&&(this._computed.zIndex=f,d.zIndex=f,this._onZIndex(f));break;case "x":case "y":f=
Math.floor(f);case "r":case "scale":this._computed[e]!=f&&(i[e]=this._computed[e],this._computed[e]=f,c=!0);break;default:this._computed[e]!=f&&(++h,this._computed[e]=f,"width"==e||"height"==e?(d[e]=f+"px",j=!0):"visible"==e?d.display=f?this._displayStyle||"block":"none":"opacity"==e?d[e]=f:(d[e]=f,k[e]||(this[e]=f)))}}if(c)if(++h,AVOID_CSS_ANIM){var g={scale:i.scale||this._computed.scale,r:i.r||this._computed.r};if(b&&(g.scale!=this._computed.scale||g.r!=this._computed.r))animate(g).now({scale:this._computed.scale,
r:this._computed.r},b.duration,b.easing,bind(this,function(){d.WebkitTransform="scale("+(this._computed.flipX?-1*g.scale:g.scale)+","+(this._computed.flipY?-1*g.scale:g.scale)+") rotate("+g.r+"rad)"})).then(bind(this,function(){d.WebkitTransform="scale("+(this._computed.flipX?-1*g.scale:g.scale)+","+(this._computed.flipY?-1*g.scale:g.scale)+") rotate("+this._computed.r+"rad)"}));else if(g.scale!=this._computed.scale||g.r!=this._computed.r)d.WebkitTransform="scale("+(this._computed.flipX?-1*this._computed.scale:
this._computed.scale)+","+(this._computed.flipY?-1*this._computed.scale:this._computed.scale)+") rotate("+this._computed.r+"rad)";d.left=(this._center?-this.width/2|0:0)+this._computed.x+"px";d.top=(this._center?-this.height/2|0:0)+this._computed.y+"px"}else{c=new WebKitCSSMatrix;c=c.translate(this._computed.x,this._computed.y);c=c.rotate(180*this._computed.r/3.14159);c=c.scale(this._computed.scale);if(this._computed.flipX||this._computed.flipY)c=c.translate(this._computed.flipX?-this._computed.width:
0,this._computed.flipY?this._computed.height/2:0),c=c.scale(this._computed.flipX?-1:1,this._computed.flipY?-1:1),c=c.translate(this._computed.flipX?this._computed.width:0,this._computed.flipY?-this._computed.height/2:0);c=c.rotate(0,360,0);d.WebkitTransform=c}j&&this._onSizeChanged&&this._onSizeChanged();return h};this._setCenter=function(){var a=this._node.style,b=!this._circle?0:-(this.width/2|0),c=!this._circle?0:-(this.height/2|0);AVOID_CSS_ANIM&&(b+=this._computed.x,c+=this._computed.y);a.left=
b+"px";a.top=c+"px"};this._onSizeChanged=function(){this._setCenter();this._view.needsReflow()};this._sortIndex="00000000";this._onZIndex=function(a){a=~~a;-99999999>a&&(a=this._zIndex=-99999999);99999999<a&&(a=this._zIndex=99999999);0>a?(a*=-1,this._sortIndex="-"+"00000000".substring(0,8-(""+a).length)+a):this._sortIndex="00000000".substring(0,8-(""+a).length)+a;this._setSortKey()};this._setAddedAt=function(a){this._addedAt=a;this._setSortKey()};this._setSortKey=function(){this.__sortKey=this._sortIndex+
this._addedAt};this._transitionEnd=function(a){$.stopEvent(a);this.transitionCallback.fired()||(this.transitionCallback.fire(),this.transitionCallback.reset(),a?a.cancelBubble=!0:this._transitionEndTimeout&&(this._transitionEndTimeout=null),this._node.style.webkitTransition="none",this._animating=!1,this._animationCallback&&(a=this._animationCallback,this._animationCallback=null,a()),this._processAnimation())};this._processAnimation=function(a){if(!(0==this._animationQueue.length||this._isPaused))if(a&&
(clearTimeout(this._queuedTimeout),this._queuedTimeout=null),!this._queuedTimeout)if(a)switch(a=this._animationQueue.shift(),a.type){case "animate":var b=this._node.style;b.webkitTransitionProperty=AVOID_CSS_ANIM?"left, top, opacity, width, height":"-webkit-transform, opacity, width, height";b.webkitTransitionDuration=(a.duration|0)+"ms";b.webkitTransitionTimingFunction="string"==typeof a.easing?a.easing:a.easing==transitions.easeIn?"ease-in":a.easing==transitions.easeOut?"ease-out":a.easing==transitions.easeInOut?
"ease-in-out":a.easing==transitions.linear?"linear":"ease";this._setProps(a.props,a);case "wait":this._animating=!0;this._animationCallback=a.callback||null;this.transitionCallback=new Callback;this.transitionCallback.runOrTimeout(function(){},bind(this,function(a){this._transitionEnd(a)}),a.duration);break;case "callback":a.callback(),this._animating||this._processAnimation()}else this._queuedTimeout||(this._queuedTimeout=setTimeout(bind(this,function(){this._queuedTimeout=false;this._processAnimation(true)}),
0))};this.getQueue=function(){return[]};this.getAnimation=function(){return this};this.animate=function(){return!arguments[0]?this:this.next.apply(this,arguments)};this.clear=function(){this.transitionCallback&&this.transitionCallback.fire();this._transitionEndTimeout&&clearTimeout(this._transitionEndTimeout);this._animationQueue=[];this._animationCallback=null;this._animating=!1;return this};this.finishNow=function(){this._node.style.webkitTransition="none";return this};this.pause=function(){this._isPaused=
!0};this.resume=function(){this._isPaused=!1;this._processAnimation()};this.animate=function(a,b,c,d){return this.then(a,b,c,d)};this.now=function(a,b,c,d){this.clear();return this.then(a,b,c,d)};this.then=function(a,b,c,d){if(1==arguments.length&&"function"===typeof a)return this.callback(a);this._animationQueue.push({type:"animate",props:a,duration:b||600,callback:d&&bind(this,d),easing:c});1==this._animationQueue.length&&!this._animating&&this._processAnimation();return this};this.callback=function(a){this._animationQueue.push({type:"callback",
duration:0,callback:a&&bind(this,a)});1==this._animationQueue.length&&!this._animating&&this._processAnimation();return this};this.wait=function(a,b){this._animationQueue.push({type:"wait",duration:a,callback:b});1==this._animationQueue.length&&!this._animating&&this._processAnimation();return this};this.fadeIn=function(a,b){this.show();if(1==this._node.style.opacity)b&&b();else return this.then({opacity:1},a,null,b),this};this.fadeOut=function(a,b){if(0==this._node.style.opacity)this.hide(),b&&b();
else return this.then({opacity:0},a,null,bind(this,function(){this.hide();b&&b()})),this}});
