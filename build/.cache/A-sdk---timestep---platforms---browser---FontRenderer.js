6e82e6a2065f5d7cc19f088dcd927518
jsio("import ui.resource.Font as Font");jsio("import ui.Engine as Engine");jsio("import .FontBuffer as FontBuffer");jsio("import device");var _customFonts={},_customFontInfo={},_fontMap={},_buffers=[],_fontBuffer=!1,_origMeasureText;function loadCustomFontImage(a,c){var b=new Image;b.onload=function(){b.onload=null;a.imagesLoaded++;a.loaded=a.imagesLoaded===a.imagesTotal};b.src="resources/fonts/"+a.filename+c+".png";return b}
function findVerticalInfo(a){var c=[{start:65,end:90},{start:97,end:122},{start:32,end:255}],b,e,d=!1,f=0,g=0,i;for(i=0;i<c.length;i++){b=c[i];for(j=b.start;j<=b.end;j++)if(e=a[j])f=Math.max(f,e.h),g=Math.max(g,e.h),d=!0;if(d)break}return{baseline:f,bottom:g}}function findHorizontalInfo(a){var c=[{start:97,end:122},{start:65,end:90},{start:32,end:255}],b,e,d=0,f=0,g,i;for(g=0;g<c.length;g++){b=c[g];for(i=b.start;i<=b.end;i++)if(e=a[i])d+=e.w,f++;if(0!==f)break}return{width:d/f}}
function loadingCustomFont(a){if(-1!==a.imagesLoaded)return!a.loaded;var c=a.settings,b=c.filename,e,d;_customFontInfo[b]?(b=_customFontInfo[b],a.dimensions=b.dimensions,a.horizontal=b.horizontal,a.vertical=b.vertical):(e="resources/fonts/"+b,d=CACHE[e+".json"],null==d&&((d=CACHE[e+".js"])?d=d.replace(/^\s*exports\s*=\s*|;\s*$/g,""):logger.warn("Could not load font",a.name,"from cached path",e)),a.dimensions=JSON.parse(d),a.horizontal=findHorizontalInfo(a.dimensions),a.vertical=findVerticalInfo(a.dimensions),
_customFontInfo[b]={dimensions:a.dimensions,horizontal:a.horizontal,vertical:a.vertical});a.images=[];a.imagesLoaded=0;b=a.images;switch(a.type){case "color":for(e=0;e<c.count;e++)b[e]=[],b[e].push(loadCustomFontImage(a,"_0_"+e)),a.imagesTotal++;break;case "composite":for(e=1;3>e;e++){b[e-1]=[];for(d=0;d<c.count;d++)b[e-1].push(loadCustomFontImage(a,"_"+e+"_"+d)),a.imagesTotal++}}return!0}
(function(){var a=window.CONFIG;if(a&&a.fonts)for(var a=a.fonts,c,b,e=a.length;e;)c=a[--e],b={filename:c.filename,settings:c,imagesLoaded:-1,imagesTotal:0,loaded:!1,type:"color"},_customFonts[c.contextName+" color"]=b,loadingCustomFont(b),b={filename:c.filename,settings:c,imagesLoaded:-1,imagesTotal:0,loaded:!1,type:"composite"},_customFonts[c.contextName+" composite"]=b,loadingCustomFont(b)})();function getCanvas(){return document.createElement("canvas")}
function getBuffers(a,c,b,e){var c=c.filename+"_"+b+"_"+e,e=[],d;if(!_buffers[c]){_buffers[c]={buffers:e};for(d=0;d<a.length;d++){var f=getCanvas(),g=f.getContext("2d"),i=a[d].width,h=a[d].height;e[d]=f;f.width=i;f.height=h;g.save();g.fillStyle=b;g.fillRect(0,0,i,h);g.globalCompositeOperation="destination-in";g.drawImage(a[d],0,0);g.restore()}}_buffers[c].lastUsed=+new Date;return _buffers[c].buffers}
function measure(a,c,b){var e=c.customFont,d=e.dimensions,f=c.scale,g=(e.settings.outline||0)*f,i=(e.settings.tracking||0)*f,h=0,k=!0;if(d)for(var m=0,l=b.length,k=!1;m<l&&!k;){character=b.charCodeAt(m);switch(character){case 9:h+=4*e.horizontal.width*f;break;case 32:h+=e.horizontal.width*f;break;default:d[character]?(character=d[character],h+=(character.ow-2)*f):k=!0}h+=i-g;m++}return k?(e=a.font,a.font=c.size.value+c.size.unit+" "+(a.defaultFontFamily||device.defaultFontFamily),c={failed:!0,width:_origMeasureText.apply(a,
[b])},a.font=e,c):{failed:!1,width:h+2*f}}
function renderCustomFont(a,c,b,e,d,f,g){var i=measure(a,f,e);if(i.failed)return!1;var h=f.customFont,k=h.images[g],m=h.dimensions,f=f.scale,l=i.width,i=(h.settings.outline||0)*f,n=(h.settings.tracking||0)*f;switch(a.textBaseline){case "alphabetic":b-=h.vertical.baseline*f;break;case "middle":b-=h.vertical.bottom/2*f;break;case "bottom":b-=h.vertical.bottom*f}switch(a.textAlign){case "center":c-=l/2;break;case "right":c-=l}"composite"===h.type&&(k=getBuffers(k,h,d,g));g=0;for(l=e.length;g<l;){d=e.charCodeAt(g);
switch(d){case 9:c+=4*h.horizontal.width*f+n-i;break;case 32:c+=h.horizontal.width*f+n-i;break;default:d=m[d],a.drawImage(k[d.i],d.x,d.y,d.w,d.h,c,b+(d.oh-1)*f,(d.w-2)*f,(d.h-2)*f),c+=(d.ow-2)*f+n-i}g++}return!0}exports.findFontInfo=function(a){var a=Font.parse(a.font),c=a.getName();return c&&_customFonts[c]?(customFont=_customFonts[c],a.customFont=customFont,a.scale=a.getSize()/customFont.settings.size,a):!1};
exports.wrapMeasureText=function(a){_origMeasureText=a;return function(c){var b=exports.findFontInfo(this);if(!b)return a.apply(this,arguments);b=measure(this,b,c);return b.failed?a.apply(this,arguments):b}};
exports.wrapFillText=function(a){return function(c,b,e){var d=exports.findFontInfo(this);if(!d)return a.apply(this,arguments);if(!loadingCustomFont(d.customFont)&&(isNaN(b)&&(b=0),isNaN(e)&&(e=0),!renderCustomFont(this,b,e,c+"",this.fillStyle,d,0))){var f=this.font;this.font=d.size.value+d.size.unit+" "+(this.defaultFontFamily||device.defaultFontFamily);a.apply(this,[c,b,e]);this.font=f}}};
exports.wrapStrokeText=function(a){return function(c,b,e){var d=exports.findFontInfo(this);if(!d)return a.apply(this,arguments);if(!loadingCustomFont(d.customFont)&&(isNaN(b)&&(b=0),isNaN(e)&&(e=0),!renderCustomFont(this,b,e,c+"",this.strokeStyle,d,1))){var f=this.font;this.font=d.size.value+d.size.unit+" "+(this.defaultFontFamily||device.defaultFontFamily);a.apply(this,[c,b,e]);this.font=f}}};exports.getFontBuffer=function(){return _fontBuffer};
