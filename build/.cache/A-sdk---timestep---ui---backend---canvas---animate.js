fc98b4fb1326d92db3543b3b3cd13aba
jsio("import event.Emitter as Emitter");jsio("import animate.transitions as transitions");jsio("import timer");var anim_uid=0;exports=function(a,b){"undefined"==typeof Engine&&(jsio("import ui.Engine as Engine"),jsio("import ui.View as View"));var b=b||0,d=groups[b]||(groups[b]=new Group),c=a.__anim_id||(a.__anim_id="__anim_"+ ++anim_uid),e=d.get(c);e||(e=a instanceof View?new ViewAnimator(a,d):new Animator(a,d),d.add(c,e));return e};exports.getViewAnimator=function(){return ViewAnimator};
exports.setViewAnimator=function(a){ViewAnimator=a};
var Group=__class__,Group=Group(function(){return this.init&&this.init.apply(this,arguments)},Emitter,function(){this.init=function(){this._anims={};this._pending=[]};this.get=function(a){return this._anims[a]};this.add=function(a,b){this._anims[a]=b;b.id=a;return b};this.isActive=function(){for(var a in this._anims)if(this._anims[a].hasFrames())return!0;return!1};this.onAnimationFinish=function(a){delete this._anims[a.id];this.isActive()||this.publish("Finish")}}),groups={"0":new Group};
exports.getGroup=function(a){return groups[a||0]};var TRANSITIONS=[transitions.easeInOut,transitions.linear,transitions.easeIn,transitions.easeOut,transitions.easeInOut,transitions.bounce];exports.linear=1;exports.easeIn=2;exports.easeOut=3;exports.easeInOut=4;exports.bounce=5;function getTransition(a){return"function"==typeof a?a:TRANSITIONS[a|0]}
var Frame=__class__,Frame=Frame(function(){return this.init&&this.init.apply(this,arguments)},function(){this.init=function(a){this.subject=a.subject;this.target=a.target;this.duration=a.duration||0;this.transition=getTransition(a.transition);this.onTick=a.onTick};this.exec=function(){};this.onInterrupt=function(){}}),CallbackFrame=__class__,CallbackFrame=CallbackFrame(function(){return this.init&&this.init.apply(this,arguments)},Frame,function(){this.exec=function(a,b){this.target.apply(this.subject,
arguments)}}),WaitFrame=Frame,ObjectFrame=__class__,ObjectFrame=ObjectFrame(function(){return this.init&&this.init.apply(this,arguments)},Frame,function(){this.exec=function(a,b,d){if(!this.base){this.base={};for(var c in this.target)this.base[c]=this.subject[c]}for(c in this.target)this.subject[c]=(this.target[c]-this.base[c])*a+this.base[c];if(d){b={};for(c in this.target)b[c]=this.subject[c]+" -> "+this.target[c];logger.log(this.duration,a,JSON.stringify(b))}}}),ViewStyleFrame=__class__,ViewStyleFrame=
ViewStyleFrame(function(){return this.init&&this.init.apply(this,arguments)},Frame,function(){this._resolvedDeltas=!1;this.init=function(a){this.subject=a.subject;this.target=merge({},a.target);this.duration=0===a.duration?0:a.duration||500;this.transition=getTransition(a&&a.transition);this.onTick=a.onTick};this.resolveDeltas=function(a){var b=this.target;this._resolvedDeltas=!0;for(var d in b){var c=d.substring(1);"d"==d.charAt(0)&&(!(d in a)&&c in a)&&(b[c]=b[d]+a[c],delete b[d])}};this.exec=function(a,
b,d){var c=this._baseStyle||(this._baseStyle=this.subject.style.copy()),b=this.target;this._resolvedDeltas||this.resolveDeltas(this._baseStyle);var c=this._baseStyle,e;for(e in b)e in c&&(this.subject.style[e]=(b[e]-c[e])*a+c[e]);this.subject.needsRepaint();if(d){d={};for(e in b)d[e]=this.subject.style[e]+" -> "+b[e];logger.log(timer.now,this.duration,a,JSON.stringify(d))}};this.onInterrupt=function(){}});exports.Animator=__class__;
var Animator=exports.Animator=exports.Animator(function(){return this.init&&this.init.apply(this,arguments)},Emitter,function(){this.init=function(a,b){this.subject=a;this._group=b;this.clear();this._isPaused=!1};this.clear=function(){this._elapsed=0;this._queue=[];this._unschedule();return this};this.pause=function(){this._isPaused||(this._isPaused=!0,this._unschedule())};this.resume=function(){this._isPaused&&(this._isPaused=!1,this._schedule())};this._schedule=function(){this._isScheduled||(this._isScheduled=
!0,Engine.get().subscribe("Tick",this,"onTick"))};this._unschedule=function(){this._isScheduled&&(this._isScheduled=!1,Engine.get().unsubscribe("Tick",this,"onTick"))};this.isPaused=function(){return this._isPaused};this.hasFrames=function(){return!!this._queue[0]};this.wait=function(a){return this.then(new WaitFrame({duration:a}))};this.buildFrame=function(a){return"function"==typeof a.target?new CallbackFrame(a):"object"==typeof a.target?new ObjectFrame(a):new WaitFrame(a)};this.now=function(a,
b,d,c){d=d||(this._queue[0]?exports.easeOut:exports.easeInOut);a=a instanceof Frame?a:this.buildFrame({subject:this.subject,target:a,duration:b,transition:d,onTick:c});(b=this._queue[0])&&b.onInterrupt(a);this.clear();return this.then(a)};this.then=function(a,b,d,c){a=a instanceof Frame?a:this.buildFrame({subject:this.subject,target:a,duration:b,transition:d,onTick:c});this._queue.length||(this._elapsed=0);this._queue.push(a);this._schedule();return this};this.debug=function(){this._debug=!0;return this};
this.commit=function(){for(var a=this._elapsed=0,b;b=this._queue[a];++a)this._elapsed+=b.duration;this.next();return this};this.onTick=function(a){this._elapsed+=a;this.next();if(!this._isScheduled)this._group.onAnimationFinish(this)};this.next=function(){var a;if(this._queue[0]){for(;a=this._queue[0];){var b=this._elapsed>=a.duration,d=b?1:this._elapsed/a.duration,c=a.transition(d);b&&(this._elapsed-=a.duration);try{a.exec(c,d,this._debug),a.onTick&&a.onTick.call(a.subject,c,d)}finally{if(b&&a==
this._queue[0]&&this._queue.shift(),!b||this._isPaused)return}}this._unschedule()}}}),ViewAnimator=__class__,ViewAnimator=ViewAnimator(function(){return this.init&&this.init.apply(this,arguments)},Animator,function(a){this.buildFrame=function(b){return"object"==typeof b.target?new ViewStyleFrame(b):a(this,"buildFrame",arguments)}});
