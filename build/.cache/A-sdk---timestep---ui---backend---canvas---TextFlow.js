42f1e413a1765a5d3461b66328befbc1
jsio("import lib.Enum as Enum");jsio("import lib.PubSub as PubSub");
var textFlowMode=Enum("NONE","WRAP","AUTOSIZE","AUTOSIZE_WRAP","AUTOFONTSIZE","AUTOFONTSIZE_WRAP","AUTOFONTSIZE_AUTOSIZE","AUTOFONTSIZE_WRAP_AUTOSIZE"),sdk_timestep_ui_backend_canvas_TextFlow=__class__,TextFlow=exports=sdk_timestep_ui_backend_canvas_TextFlow(function(){return this.init&&this.init.apply(this,arguments)},PubSub,function(l){this.init=function(a){l(this,"init",arguments);this._target=a.target;this._lineWidth=0;this._line=[];this._lines=[];this._cache=[];this._maxHeight=this._maxWidth=
this._maxWordWidth=this._cacheSize=0;this._heightFound=-1;this._offsetRect={x:0,y:0,width:0,height:0}};this._lineSplit=function(a){var f=a.measureText(" ").width,c=this._opts,b=c.text||"",c=c.wrap||"justify"===c.horizontalAlign?b.replace(/\t/g," ").match(/\S+|[\n]| +(?= )/g)||[]:b.split("\n"),d=0,e=c.length;this._line=[];for(this._maxWordWidth=this._lineWidth=0;d<e;)b={word:c[d],width:a.measureText(c[d]).width,line:1},this._line.push(b),this._lineWidth+=b.width+f,this._maxWordWidth=Math.max(this._maxWordWidth,
b.width),d++;this._lineWidth-=f};this._measureWords=function(a){var f=a.measureText(" ").width,c=0,b=this._line.length;for(this._maxWordWidth=this._lineWidth=0;c<b;)word=this._line[c],word.line=1,word.width=a.measureText(word.word).width,this._lineWidth+=word.width+f,this._maxWordWidth=Math.max(this._maxWordWidth,word.width),c++;this._lineWidth-=f};this._wrap=function(a,f){var c=a.measureText(" ").width,b,d=0,e=[],h=[],g="";this._lines=e;var i=this._maxWidth=0,j=this._line.length;if("justify"===this._opts.horizontalAlign){for(;i<
j;)b=this._line[i++],d+=b.width+c,"\n"===b.word?(e.push(h),h=[],d=0):d>f?(h.length&&e.push(h),h=[b],d=b.width+c):h.push(b);h.length&&e.push(h)}else{for(;i<j;)b=this._line[i++],d=a.measureText(g).width,"\n"===b.word?(e.push([{word:g,width:d,line:e.length}]),g=""):d+b.width+c>f?(""!==g&&e.push([{word:g,width:d,line:e.length}]),g=b.word):g+=(""!==g?" ":"")+b.word;""!==g&&e.push([{word:g,width:a.measureText(g).width,line:e.length}])}};this._getLineSize=function(a){var f=this._opts;return(1>=a?1:f.lineHeight)*
f.size};this._wordFlow=function(a){var a=a.measureText(" ").width,f=this._lines;this._cache=[];for(var c=this._maxHeight=this._maxWidth=this._cacheSize=0,b=f.length,d=this._getLineSize(b),e=0;c<b;){for(var h=f[c++],g=0,i=h.length,j=0;g<i;){var k=h[g++];k.x=j;k.y=e;k.line=c;this._cache[this._cacheSize++]=k;j+=k.width+a}e+=d;j-=a;this._maxWidth=Math.max(this._maxWidth,j);this._maxHeight=Math.max(this._maxHeight,e)}};this._checkWidth=function(a,f){if(""===this._opts.text)return!1;var c=this._opts;if(f>
this.getActualWidth()){var b=c.size*this._target.style.width/f|0;c.size!==b&&this.publish("ChangeSize",b,a);return!0}return!1};this._checkHeight=function(a,f,c,b){if(""!==this._opts.text&&!(2>Math.abs(c-f))){var d=Math.max(f+c>>1,1);this.publish("ChangeSize",d,a);b();if(1!==d){var e=this._opts;this._lines.length*this._getLineSize(this._lines.length)>this.getActualHeight()?this._checkHeight(a,f,d,b):(this._heightFound=e.size,this._checkHeight(a,d,c,b))}}};this._horizontalAlign=function(a){var f=this.getPaddingLeft(),
a=a.measureText(" ").width,c={left:-1,center:2,right:1,justify:3}[this._opts.horizontalAlign],b=this._cache,d=this.getActualWidth(),e,h;if(b.length){3===c&&(a=0);for(var g,i=0,j=b.length;i<j;){g=i;h=b[i].line;for(e=0;i<j&&h===b[i].line;)e+=b[i].width+a,i++;if(-1===c)for(;g<i;)b[g++].x+=f;else if(3===c){e=h<b[b.length-1].line?(d-e)/(i-g-1):a;for(h=f;g<i;)b[g].x=h,h+=b[g].width+e,g++}else for(e=(d-e+a)/c+f;g<i;)b[g++].x+=e}}};this._verticalAlign=function(){var a=this._lines.length,f={top:-1,middle:2,
bottom:1}[this._opts.verticalAlign],c=this._cache,b=this.getActualHeight(),d=c.length;if(c.length){if(-1===f)a=this.getPaddingTop();else var e=this._getLineSize(a),a=(b-a*e)/f+this.getPaddingTop();for(;d;)c[--d].y+=a;this._offsetRect.y+=a}};this.reflow=function(a,f){var c=this._opts,b=this.getActualWidth(),d=this.getActualHeight();this._lineSplit(a);switch(f){case textFlowMode.NONE:this._lines=[this._line];this._wordFlow(a);break;case textFlowMode.WRAP:this._wrap(a,b);this._wordFlow(a);break;case textFlowMode.AUTOSIZE:case textFlowMode.AUTOFONTSIZE_AUTOSIZE:this._lines=
[this._line];this._wordFlow(a);b<this._maxWidth&&this.publish("ChangeWidth",this._maxWidth+this.getHorizontalPadding());d<this._maxHeight&&this.publish("ChangeHeight",this._maxHeight+this.getVerticalPadding());break;case textFlowMode.AUTOSIZE_WRAP:this._wrap(a,b);this._wordFlow(a);b<this._maxWidth&&this.publish("ChangeWidth",this._maxWidth+this.getHorizontalPadding());d<this._maxHeight&&this.publish("ChangeHeight",this._maxHeight+this.getVerticalPadding());break;case textFlowMode.AUTOFONTSIZE:this._checkWidth(a,
this._lineWidth)&&this._lineSplit(a);this._lines=[this._line];c.allowVerticalSizing&&c.size>this.getActualHeight()?(d=bind(this,function(){this._measureWords(a);this._wordFlow(a)}),this._checkHeight(a,1,c.size,d),this.publish("ChangeSize",this._heightFound,a),d()):this._wordFlow(a);break;case textFlowMode.AUTOFONTSIZE_WRAP:this._wrap(a,b);this._checkWidth(a,this._maxWordWidth)&&(this._lineSplit(a),this._wrap(a,b));this._wordFlow(a);var e=this._lines.length,d=this._getLineSize(e);c.allowVerticalSizing&&
e*d>this.getActualHeight()&&(d=bind(this,function(){this._measureWords(a);this._wrap(a,b);this._wordFlow(a)}),this._checkHeight(a,1,c.size,d),this.publish("ChangeSize",this._heightFound,a),d());break;case textFlowMode.AUTOFONTSIZE_WRAP_AUTOSIZE:this._wrap(a,b),this._checkWidth(a,this._maxWordWidth)&&(this._lineSplit(a),this._wrap(a,b)),this._wordFlow(a),d<this._maxHeight&&this.publish("ChangeHeight",this._maxHeight+this.getVerticalPadding())}c=this._cache;e=c[c.length-1];c.length&&(d=this._getLineSize(this._lines.length),
this._offsetRect.x=0,this._offsetRect.y=0,this._offsetRect.width=this.getActualWidth(),this._offsetRect.height=e.line*d,this._horizontalAlign(a),this._verticalAlign(),1===e.line&&(this._offsetRect.x=c[0].x,this._offsetRect.width=e.x+e.width-c[0].x))};this.setOpts=function(a){this._opts=a};this.getCache=function(){return this._cache};this.getHorizontalPadding=function(){var a=this._target.style.padding;return a.left+a.right};this.getPaddingLeft=function(){return this._target.style.padding.left};this.getActualWidth=
function(){return this._target.style.width-this.getHorizontalPadding()};this.getVerticalPadding=function(){var a=this._target.style.padding;return a.top+a.bottom};this.getPaddingTop=function(){return this._target.style.padding.top};this.getActualHeight=function(){return this._target.style.height-this.getVerticalPadding()};this.getOffsetRect=function(){return this._offsetRect}});
