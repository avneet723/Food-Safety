048e961f705d86255f604e645bbe7dce
jsio("import event.Callback as Callback");jsio("import math.geom.Rect as Rect");jsio("import device");jsio("import ui.resource.loader as resourceLoader");var ImageCache={};function imageOnLoad(o,n,f){if(o&&!this.width)return 3<f?(this.onLoad=this.onError=null,this.__cb.fire(!1)):setTimeout(bind(this,imageOnLoad,o,n,(f||0)+1),0);this.__cb.fire(o);this.onLoad=this.onError=null}var ImageMap=!GLOBAL.CONFIG.disableNativeViews&&GLOBAL.NATIVE&&GLOBAL.NATIVE.timestep&&GLOBAL.NATIVE.timestep.ImageMap;
ImageMap||(ImageMap=__class__,ImageMap=ImageMap(function(){return this.init&&this.init.apply(this,arguments)},function(){this.init=function(o,n,f,i,a,d,g,k,l,h){this.url=h;this.x=n;this.y=f;this.width=i;this.height=a;this.marginTop=d;this.marginRight=g;this.marginBottom=k;this.marginLeft=l}}));var sdk_timestep_ui_resource_Image=__class__;
exports=sdk_timestep_ui_resource_Image(function(){return this.init&&this.init.apply(this,arguments)},function(){this.init=function(a){a||(a={});this._cb=new Callback;this._map=new ImageMap(this,0,0,-1,-1,0,0,0,0,a.url||"");this._originalURL=a.url;resourceLoader._updateImageMap(this._map,a.url,a.sourceX,a.sourceY,a.sourceW,a.sourceH);this._scale=a.scale;this._setSrcImg(a.srcImage,this._map.url)};this._setSrcImg=function(a,d){this._cb.reset();!a&&(d&&ImageCache[d])&&(a=ImageCache[d]);if(!a&&Image.get){var g=
Image.get(d);typeof g=="object"?a=g:g&&(d=g)}if(a&&a.complete){this._srcImg=a;this._onLoad(true)}else{this._srcImg=a=a||new Image;if(!a.__cb){a.__cb=new Callback;a.addEventListener("load",bind(a,imageOnLoad,true),false);a.addEventListener("error",bind(a,imageOnLoad,false),false);d&&(ImageCache[d]=a);if(!a.src&&d)this._srcImg.src=this._map.url=d}a.__cb.run(this,"_onLoad")}};this.setSource=this.setSrcImg=function(a){this._setSrcImg(a)};this.__reload__=function(a){if(this._srcImg){var d=a.chain(),g=
bind(this,function(){this._srcImg.removeEventListener("reload",g,false);d()});this._srcImg.addEventListener("reload",g,false)}};this.setURL=function(a){resourceLoader._updateImageMap(this._map,a);this._setSrcImg(null,this._map.url)};this.getURL=function(){return this._map.url};this.getOriginalURL=function(){return this._originalURL};this.getSourceWidth=this.getOrigWidth=this.getOrigW=function(){return this._srcImg.width};this.getSourceHeight=this.getOrigHeight=this.getOrigH=function(){return this._srcImg.height};
this.setSourceWidth=this.setSourceW=function(a){this._map.width=a};this.setSourceHeight=this.setSourceH=function(a){this._map.height=a};this.setSourceY=this.setSourceY=function(a){this._map.y=a};this.setSourceX=this.setSourceX=function(a){this._map.x=a};this.setMarginTop=function(a){this._map.marginTop=a};this.setMarginRight=function(a){this._map.marginRight=a};this.setMarginBottom=function(a){this._map.marginBottom=a};this.setMarginLeft=function(a){this._map.marginLeft=a};this.getURL=function(){return this._map.url};
this.getSourceWidth=this.getOrigWidth=this.getOrigW=function(){return this._srcImg.width};this.getSourceHeight=this.getOrigHeight=this.getOrigH=function(){return this._srcImg.height};this.setSourceWidth=this.setSourceW=function(a){this._map.width=a};this.setSourceHeight=this.setSourceH=function(a){this._map.height=a};this.setSourceY=this.setSourceY=function(a){this._map.y=a};this.setSourceX=this.setSourceX=function(a){this._map.x=a};this.setMarginTop=function(a){this._map.marginTop=a};this.setMarginRight=
function(a){this._map.marginRight=a};this.setMarginBottom=function(a){this._map.marginBottom=a};this.setMarginLeft=function(a){this._map.marginLeft=a};this.getSource=function(){return this._srcImg};this.getWidth=function(){return(this._map.width==-1?0:this._map.width+this._map.marginLeft+this._map.marginRight)/this._map.scale};this.getHeight=function(){return(this._map.height==-1?0:this._map.height+this._map.marginTop+this._map.marginBottom)/this._map.scale};this.getMap=this.getBounds=function(){return this._map};
this.setBounds=function(a,d,g,f,i,h,b,c){var j=this._map;j.x=a;j.y=d;j.width=g;j.height=f;j.marginTop=i||0;j.marginRight=h||0;j.marginBottom=b||0;j.marginLeft=c||0};this.setBounds=this.setMap;this.doOnLoad=function(){this._cb.forward(arguments);return this};this._onLoad=function(a){if(a){this._srcImg.width==0&&logger.warn("Image has no width",this._url);a=this._map;if(this._scale&&(a.width!=-1||a.height!=-1)){if(a.width==-1)a.width=this._srcImg.width*a.height/this._srcImg.height;if(a.height==-1)a.height=
this._srcImg.height*a.width/this._srcImg.width;this._srcImg.width=a.width;this._srcImg.height=a.height}else{if(a.width==-1)a.width=this._srcImg.width;if(a.height==-1)a.height=this._srcImg.height}this._map.url=this._srcImg.src;this._cb.fire(null,this)}else{logger.error("Image failed to load:",this._map.url);this._cb.fire({NoImage:true})}};this.isLoaded=this.isReady=function(){return this._cb.fired()};var o=GLOBAL.NATIVE&&!device.simulatingMobileNative,n=Array.prototype.slice;if(!o)var f=new (device.get("Canvas")),
i=f.getContext("2d");this.render=function(a,d,g,k,l){if(this._cb.fired())try{var h=arguments,b=this._map,c,j;if(!a.filters||!a.filters.Multiply&&!a.filters.NegativeMask&&!a.filters.PositiveMask)if(h.length==9)a.drawImage(this._srcImg,h[1],h[2],h[3],h[4],h[5],h[6],h[7],h[8]);else if(d instanceof Rect)if(g instanceof Rect){var h=d,m=g;c=m.width/(b.marginLeft+b.width+b.marginRight);j=m.height/(b.marginTop+b.height+b.marginBottom);a.drawImage(this._srcImg,h.x,h.y,h.width,h.height,m.x,m.y,m.width,m.height)}else{m=
d;c=m.width/(b.marginLeft+b.width+b.marginRight);j=m.height/(b.marginTop+b.height+b.marginBottom);a.drawImage(this._srcImg,b.x,b.y,b.width,b.height,m.x+c*b.marginLeft,m.y+j*b.marginTop,c*b.width,j*b.height)}else{c=k/(b.marginLeft+b.width+b.marginRight);j=l/(b.marginTop+b.height+b.marginBottom);a.drawImage(this._srcImg,b.x,b.y,b.width,b.height,(d||0)+c*b.marginLeft,(g||0)+j*b.marginTop,c*b.width,j*b.height)}var r=arguments,q=this;c=function(c,e,h){f.width=k;f.height=l;i.globalCompositeOperation="source-over";
q.render.apply(q,[i].concat(n.call(r,1)));i.globalCompositeOperation=e;i.fillStyle="rgba("+c.r+","+c.g+","+c.b+","+c.a+")";i.fillRect(d||0,g||0,k||b.width,l||b.height);c=a.globalCompositeOperation;a.globalCompositeOperation=h;a.drawImage(f,d||0,g||0,k||b.width,l||b.height);a.globalCompositeOperation=c};/WebKit/.exec(navigator.appVersion);if(!o&&a.filters){if(a.filters.LinearAdd){var e=a.filters.LinearAdd.get();c(e,"source-in","lighter")}if(a.filters.Tint){e=a.filters.Tint.get();c({r:e.r,g:e.g,b:e.b,
a:e.a},"source-in","source-over")}if(a.filters.Multiply){var e=a.filters.Multiply.get(),s=this.getImageData(),p=s.data;for(c=0;c<p.length;c=c+4){p[c]=p[c]*e.r/255*e.a;p[c+1]=p[c+1]*e.g/255*e.a;p[c+2]=p[c+2]*e.b/255*e.a}f.width=s.width;f.height=s.height;i.putImageData(s,0,0);a.drawImage(f,d||0,g||0,k||b.width,l||b.height)}if(a.filters.NegativeMask){e=a.filters.NegativeMask.get();f.width=k;f.height=l;i.globalCompositeOperation="source-over";e.imgObject.render.apply(e.imgObject,[i].concat(n.call(r,1)));
i.globalCompositeOperation="source-in";q.render.apply(q,[i].concat(n.call(r,1)));var t=a.globalCompositeOperation;a.globalCompositeOperation="source-over";a.drawImage(f,d||0,g||0,k||b.width,l||b.height);a.globalCompositeOperation=t}if(a.filters.PositiveMask){e=a.filters.PositiveMask.get();f.width=k;f.height=l;i.globalCompositeOperation="source-over";e.imgObject.render.apply(e.imgObject,[i].concat(n.call(r,1)));i.globalCompositeOperation="source-out";q.render.apply(q,[i].concat(n.call(r,1)));t=a.globalCompositeOperation;
a.globalCompositeOperation="source-over";a.drawImage(f,d||0,g||0,k||b.width,l||b.height);a.globalCompositeOperation=t}}}catch(u){}};this.getImageData=function(){if(!GLOBAL.document||!document.createElement)throw"Not supported";if(!this._map.width||!this._map.height)throw"Not loaded";var a=document.createElement("canvas");a.width=this._map.width;a.height=this._map.height;var d=a.getContext("2d");this.render(d,0,0,this._map.width,this._map.height);return d.getImageData(0,0,a.width,a.height)};this.setImageData=
function(){};this.destroy=function(){this._srcImg.destroy()}});exports.__clearCache__=function(){ImageCache={}};
