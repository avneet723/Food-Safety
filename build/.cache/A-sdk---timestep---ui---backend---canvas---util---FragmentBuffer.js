4c952c38fec08808887cd7209d53e5ba
jsio("import device");jsio("import .FragmentBin");jsio("import .SortedLinkedList as SortedList");
var sdk_timestep_ui_backend_canvas_util_FragmentBuffer=__class__,FragmentBuffer=exports=sdk_timestep_ui_backend_canvas_util_FragmentBuffer(function(){return this.init&&this.init.apply(this,arguments)},function(){this.init=function(a){this.opts=merge(a,{});this._cache={};this._textViews=[];window.addEventListener("pageshow",bind(this,"clearBuffer"),!1)};var d=function(a,b){return a.size()>b.size()};this._build=function(){this._canvas=new (device.get("Canvas"))({width:1024,height:1024});this._ctx=this.getCanvas().getContext("2d");
this._ctx.clearRect(0,0,1024,1024);this._ctx.textAlign="left";this._ctx.textBaseline="middle";this._ctx.globalCompositeOperation="source-over";this._binList=new SortedList(d);this._binList.insert(new FragmentBin({x:0,y:0,width:1024,height:1024}))};this.getCanvas=function(){this._canvas||this._build();return this._canvas};this.getContext=function(){this._ctx||this._build();return this._ctx};this.onGetHash=function(){throw Error("onGetHash should be implemented.");};this._insertText=function(a){for(var b=
a.width,c=a.height,d=this._binList.iterator(),a=null,e=!1;d.hasNext()&&!e;)a=d.next(),!a.filled&&a.width>=b&&a.height>=c?e=!0:a=null;if(a){newBins=a.split(b,c);for(b=0;b<newBins.length;b++)this._binList.insert(newBins[b])}else logger.log("buffer full, further TextViews will not be cached");return a};this.getPositionForText=function(a){var b=a._opts,c=this.onGetHash(b);!this._cache[c]&&0<b.width&&(this._cache[c]=this._insertText(b),this._textViews.push(a));return this._cache[c]};this.clearBuffer=function(){this._cache=
{};this._binList=new SortedList(d);for(this._binList.insert(new FragmentBin({x:0,y:0,width:1024,height:1024}));this._textViews.length;)this._textViews.pop()._cacheUpdate=!0}});
