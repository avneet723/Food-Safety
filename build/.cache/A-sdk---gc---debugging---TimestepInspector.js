3dafc523c80328f390a3f15ef30acc01
if(DEBUG){jsio("import device");jsio("import math.geom.Point as Point");jsio("import ui.resource.Image as Image");jsio("import ui.ImageView as ImageView");jsio("import .OverlayRenderer");var _propMap={relX:"x",relY:"y",relR:"r",relWidthPercent:"widthPercent",relHeightPercent:"heightPercent",relWidth:"width",relHeight:"height",relScale:"scale",opacity:"opacity",zIndex:"zIndex",visible:"visible",anchorX:"anchorX",anchorY:"anchorY",offsetX:"offsetX",offsetY:"offsetY",clip:"clip",layout:"layout",inLayout:"inLayout",
top:"top",left:"left",bottom:"bottom",right:"right",flex:"flex",direction:"direction",justifyContent:"justifyContent",order:"order",layoutWidth:"layoutWidth",layoutHeight:"layoutHeight",centerX:"centerX",centerY:"centerY",minWidth:"minWidth",minHeight:"minHeight",maxWidth:"maxWidth",maxHeight:"maxHeight"},sdk_gc_debugging_TimestepInspector=__class__;exports=sdk_gc_debugging_TimestepInspector(function(){return this.init&&this.init.apply(this,arguments)},function(){this.init=function(){this._overlay=
new OverlayRenderer};this.setConn=function(d){function a(c){var a=c.getSuperview(),b;for(b in a)if(a[b]===c)return b;return null}this._conn=d;if(CONFIG.splash){var g=CONFIG.splash.hide;CONFIG.splash.hide=bind(this,function(){g&&g.apply(this,arguments);if(this._conn)this._conn.onConnect(this,function(){this._conn.sendEvent("HIDE_LOADING_IMAGE")})})}d.onEvent.subscribe("BATCH",this,function(c){for(var a in c.args)d.onEvent.publish(c.args[a].name,c.args[a].args)});d.onEvent.subscribe("SET_NAME",this,
function(c){GLOBAL._name=c.args.name;logging.setPrefix(c.args.name+": ")});d.onEvent.subscribe("HOME_BUTTON",this,function(){if(GC){var c=GC.app;if(this._homeScreen)GC._onShow&&GC._onShow(),c.engine.resume();else if(GC._onHide&&GC._onHide(),c.engine.pause(),c=document.getElementsByTagName("canvas"),c.length&&(c=c[0],c.getContext)){var a=c.getContext("2d");a.fillStyle="#000000";a.fillRect(0,0,c.width,c.height)}this._homeScreen^=1}});d.onEvent.subscribe("BACK_BUTTON",this,function(){GLOBAL.NATIVE.onBackButton()});
d.onRequest.subscribe("SCREENSHOT",this,function(c){var a=GC.app.engine.getElement();a&&a.toDataURL?c.respond({width:a.width,height:a.height,canvasImg:a.toDataURL("image/png")}):c.error({NOT_SUPPORTED:!0})});d.onEvent.subscribe("MUTE",this,function(c){GLOBAL.ACCESSIBILITY.mute(c.args.shouldMute)});var e=!1;d.onEvent.subscribe("PAUSE",this,function(){if(GC){var c=GC.app;e?(c.engine.resume(),this._overlay.stopTick()):(c.engine.pause(),this._overlay.startTick());e=!e}});d.onEvent.subscribe("STEP",this,
function(){GC&&(GC.app.engine.stepFrame(),e=!0)});var f=null;d.onRequest.subscribe("ADD_MOUSE_EVT",this,function(c){f||(f=new DebugInputHandler(d));c.respond()});d.onRequest.subscribe("REMOVE_MOUSE_EVT",this,function(c){f&&f.destroy();c.respond()});d.onEvent.subscribe("SET_HIGHLIGHT",this,function(c){this._overlay.setHighlight(c.args.uid)});d.onEvent.subscribe("SET_SELECTED",this,function(c){this._overlay.setSelected(c.args.uid)});d.onRequest.subscribe("GET_ROOT_UID",this,function(c){c.respond({uid:GC.app.view.uid})});
d.onRequest.subscribe("GET_VIEW",this,function(c){var b=_DEBUG.getViewByID(c.args.uid);if(b){var d=b.getSuperview(),e=b.getTag&&b.getTag()||b.toString(),f=a(b);f&&(e=f+":"+e);c.respond({uid:b.uid,superviewID:d&&d.uid,tag:e,subviewIDs:b.getSubviews().map(function(c){return c.uid})})}else c.error("no view with id"+c.args.uid,{VIEW_NOT_FOUND:!0})});d.onRequest.subscribe("REPLACE_IMAGE",this,function(c){var c=c.args,a=c.imgData,b=_DEBUG.getViewByID(c.uid),d=new Image;d._srcImg.addEventListener("load",
function(){var c=d._map;c.width=d._srcImg.width;c.height=d._srcImg.height;c.x=0;c.y=0;b.setImage(d);b.needsRepaint()},!1);d._srcImg.src=a});d.onRequest.subscribe("GET_VIEW_PROPS",this,function(c){var a=c.args,b=_DEBUG.getViewByID(a.uid);if(!b)return c.error("VIEW_NOT_FOUND");var d=b.style,e=b.getPosition(),f=b.__layout,g={},h;for(h in _propMap)g[h]=d[_propMap[h]];merge(g,{absX:e.x,absY:e.y,absR:e.r,absWidth:e.width,absHeight:e.height,absScale:e.scale,subviews:f&&"function"==typeof f.getSubviews&&
f.getSubviews().length,direction:f&&"function"==typeof f.getDirection&&f.getDirection(),padding:d.padding&&d.padding.toString()});for(h in g)void 0==g[h]&&(g[h]="-");g.isImageView=b instanceof ImageView;g.isImageView&&(g.imagePath=b._opts.image||b._img&&b._img._map&&b._img._map.url,g.imagePath&&g.imagePath._map&&(g.imagePath=g.imagePath._map.url));g.uuid=a.uid;g.description=(b.constructor.name||"View")+" "+a.uid+"\n"+b.getTag();c.respond(g)});d.onRequest.subscribe("SET_VIEW_PROP",this,function(c){var a=
c.args,b=_DEBUG.getViewByID(a.uid);if(!b)return c.error("VIEW_NOT_FOUND");c=a.key;a=a.value;if(c in _propMap)b.style[_propMap[c]]=a;else switch(c){case "absY":b.style.y=a;break;case "absWidth":b.style.width=a;break;case "absHeight":b.style.height=a;break;case "absScale":b.style.scale=a;break;case "padding":b.style.padding=a}});var b=null,h=null;d.onEvent.subscribe("POLL_VIEW_POSITION",this,function(a){function g(){if(h){var a=h.getPosition();a.uid=h.uid;d.sendEvent("POLL_VIEW_POSITION",a)}}h=_DEBUG.getViewByID(a.args.uid);
!b&&h&&(b=setInterval(g,100));h||(clearInterval(g),b=null)})};this.setApp=function(d){this._conn.sendEvent("APP_READY",{uid:d.view.uid});d.engine.unsubscribe("Render",this);d.engine.subscribe("Render",this._overlay,"render")}});var DebugInputHandler=__class__,DebugInputHandler=DebugInputHandler(function(){return this.init&&this.init.apply(this,arguments)},function(){jsio("import device");var d=device.simulating&&document.body.addEventListener;this.init=function(a){this.conn=a;this.onMouseMoveCapture=
bind(this,this.onMouseMoveCapture);this.setShiftDown=bind(this,this.setShiftDown);this.onContextMenu=bind(this,this.onContextMenu);d&&window.addEventListener("mousemove",this.onMouseMoveCapture,!0);window.addEventListener("mousedown",this.setShiftDown,!0);window.addEventListener("contextmenu",this.onContextMenu,!0);GC.app.view.subscribe("InputMoveCapture",this,"onInputMoveCapture")};this.setShiftDown=function(a){if(3===a.which||2===a.button)return a.stopPropagation(),a.preventDefault(),!1;if(this._shiftDown=
!!a.shiftKey)this.onInputSelectCapture(a),a.stopPropagation(),a.preventDefault()};jsio("import event.input.dispatch as dispatch");this.onContextMenu=function(a){var d={pt:{x:a.pageX,y:a.pageY}},e={pt:[],trace:[],depth:0},f=new Point(a.pageX,a.pageY);dispatch.traceEvt(GC.app.view,e,f);if(e.trace.length){d.active=e.trace[0].uid;e={pt:[],trace:[],depth:0};f=new Point(a.pageX,a.pageY);this.traceEvt(GC.app.view,e,f);d.trace=[];for(var f=e.trace.length-1,b;b=e.trace[f];--f)d.trace.push({uid:b.view.uid,
tag:b.view.getTag(),depth:b.depth});this.conn.sendEvent("INPUT_TRACE",d);a.stopPropagation();a.preventDefault();return!1}};this.destroy=function(){d&&window.removeEventListener("mousedown",this.onMouseDownCapture,!0);window.removeEventListener("mousedown",this.setShiftDown,!0);GC.app.view.unsubscribe("InputMoveCapture",this,"onInputMoveCapture")};this.onInputMoveCapture=function(a,d){for(var e=[],f=a.trace.length-1,b;b=a.trace[f];--f){e.push(b.uid);for(b=b.getSuperview();b&&b!=a.trace[f+1];)e.push(b.uid),
b=b.getSuperview()}this.conn.sendEvent("INPUT_MOVE",{x:d.x,y:d.y,trace:e})};this.onInputSelectCapture=function(a){var d={pt:[],trace:[],depth:0},a=new Point(a.pageX,a.pageY);dispatch.traceEvt(GC.app.view,d,a);for(var e=[],f=d.trace.length-1,b;b=d.trace[f];--f){e.push(b.uid);for(b=b.getSuperview();b&&b!=d.trace[f+1];)e.push(b.uid),b=b.getSuperview()}this.conn.sendEvent("INPUT_SELECT",{x:a.x,y:a.y,trace:e})};this.traceEvt=function(a,d,e,f){f=f||0;e=a.style.localizePoint(new Point(e));a.containsLocalPoint(e)&&
(d.trace.unshift({view:a,depth:f}),d.pt[a.uid]=e);for(var b=a.getSubviews(),h=b.length-1;0<=h;--h)b[h].style.visible&&this.traceEvt(b[h],d,e,f+1);if(0===b.length)return d.target=a,!0};this.onMouseMoveCapture=function(a){var d={pt:[],trace:[],depth:0},a=new Point(a.pageX,a.pageY);dispatch.traceEvt(GC.app.view,d,a);this.onInputMoveCapture(d,a)}})};
