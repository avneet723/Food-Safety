bbaddff0db93d450abc9e64391db6f31
jsio("import net.interfaces");jsio("from util.browser import $");jsio("import std.uuid");exports.Listener=__class__;
exports.Listener=exports.Listener(function(){return this.init&&this.init.apply(this,arguments)},net.interfaces.Listener,function(a){this.init=function(){a(this,"init",arguments);this._clients={};this._opts.clientUrl||(this._opts.clientUrl=jsio.__dir+"/networkConsole.html");this._port=""+(this._opts.port||"")};this.listen=function(){$.onEvent(window,"message",bind(this,"_onMessage"))};this.getButton=function(e,b){var a=$({tagName:"button",text:b||"launch client",className:"clientButton"});$.onEvent(a,
"click",bind(this,"openWindow",e||this._opts.clientUrl));return a};var c=1;this.openWindow=function(a){var b={menubar:"no",location:"no",toolbar:"no",width:550,height:350,scrollbars:"yes",status:"yes",resizable:"yes"},f=[],d;for(d in b)f.push(d+"="+b[d]);window.open(a,"W"+c++,f.join(",")).focus()};this._onMessage=function(a){if(this._port==a.data.substring(0,this._port.length)){var b=a.data.substring(this._port.length);try{b=JSON.parse(b)}catch(c){logger.warn("invalid packet",a.data);return}switch(b.type){case "open":var d=
this._clients[b.uid]=new exports.Transport(a.source,this._port,b.uid);a.source.postMessage(this._port+JSON.stringify({type:"open",uid:b.uid}),"*");this.onConnect(d);break;case "data":if(d=this._clients[b.uid])d.onData(b.payload);break;case "close":if(d=this._clients[b.uid])d.onClose();a.source.postMessage(this._port+JSON.stringify({type:"close",uid:b.uid}),"*");delete this._clients[b.uid]}}}});exports.Connector=__class__;
exports.Connector=exports.Connector(function(){return this.init&&this.init.apply(this,arguments)},net.interfaces.Connector,function(){this.connect=function(){this._port=""+(this._opts.port||"");this._win=this._opts.win||window.opener||window.parent;$.onEvent(window,"message",bind(this,"_onMessage"));this._uid=std.uuid.uuid();this._win.postMessage(this._port+JSON.stringify({type:"open",uid:this._uid}),"*")};this._onMessage=function(a){if(this._port==a.data.substring(0,this._port.length)){var c=a.data.substring(this._port.length);
try{c=JSON.parse(c)}catch(e){logger.warn("invalid packet",a.data);return}switch(c.type){case "open":this._transport=new exports.Transport(a.source,this._port,this._uid);this.onConnect(this._transport);break;case "close":if(c.uid!=this._uid)break;this._transport.onClose();break;case "data":if(c.uid!=this._uid)break;this._transport.onData(c.payload)}}}});exports.Transport=__class__;
exports.Transport=exports.Transport(function(){return this.init&&this.init.apply(this,arguments)},net.interfaces.Transport,function(){this.init=function(a,c,e){if(!e)debugger;this._win=a;this._port=c;this._uid=e};this.makeConnection=function(a){this._protocol=a};this.write=function(a){"utf8"==this.encoding?this._win.postMessage(this._port+JSON.stringify({type:"data",uid:this._uid,payload:utf8.encode(a)}),"*"):this._win.postMessage(this._port+JSON.stringify({type:"data",uid:this._uid,payload:a}),"*")};
this.loseConnection=function(){this._win.postMessage(this._port+JSON.stringify({type:"close",uid:this._uid,code:301}),"*")};this.onData=function(){this._protocol.dataReceived.apply(this._protocol,arguments)};this.onClose=function(){this._protocol._connectionLost.apply(this._protocol,arguments)}});
