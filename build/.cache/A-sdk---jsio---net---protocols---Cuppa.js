5c67b29f50077ae3f5b46eb8f936fc5c
"use import";jsio("import lib.Callback");jsio("import lib.PubSub");jsio("from net.protocols.rtjp import RTJPProtocol");
var Error=__class__,Error=Error(function(){return this.init&&this.init.apply(this,arguments)},function(){this.init=function(a,b,f,c,d){this.id=b;this.msg=f;this.details=c;this.requestId=d}}),RPCRequest=__class__,RPCRequest=RPCRequest(function(){return this.init&&this.init.apply(this,arguments)},function(){this.init=function(a,b){this.protocol=a;this.id=b;this._onError=new lib.Callback;this._onSuccess=new lib.Callback};this.onError=function(){this._onError.forward(arguments)};this.onSuccess=function(){this._onSuccess.forward(arguments)};
this.bindLater=function(a){var b=[].slice(arguments,1);this._onError.forward([a,a.fail].concat(b));this._onSuccess.forward([a,a.succed].concat(b));return a}}),ReceivedRequest=__class__,ReceivedRequest=ReceivedRequest(function(){return this.init&&this.init.apply(this,arguments)},function(){this.type="request";this.init=function(a,b,f,c,d){this.protocol=a;this.id=b;this.name=f;this.responded=!1;this.args=c;this.target=d};this.error=function(a,b){if(this.responded)throw Error("already responded");this._timer&&
(clearTimeout(this._timer),this._timer=null);args={id:this.id,msg:a+""};void 0!==b&&(args.details=b);this.responded=!0;this.protocol.sendFrame("ERROR",args)};this.respond=function(a){if(this.responded)throw Error("already responded");this._timer&&(clearTimeout(this._timer),this._timer=null);this.responded=!0;this.protocol.sendFrame("RESPONSE",{id:this.id,args:void 0==a?{}:a})};this.timeoutAfter=function(a,b){this.responded||(this._timer&&clearTimeout(this._timer),this._timer=setTimeout(bind(this,
"_timeout",b),a))};this._timeout=function(a){this.responded||this.error(a)}}),ReceivedEvent=__class__,ReceivedEvent=ReceivedEvent(function(){return this.init&&this.init.apply(this,arguments)},function(){this.init=function(a,b,f,c,d){this.id=b;this.name=f;this.args=c;this.target=d}}),sdk_jsio_net_protocols_Cuppa=__class__;
exports=sdk_jsio_net_protocols_Cuppa(function(){return this.init&&this.init.apply(this,arguments)},RTJPProtocol,function(a){this.init=function(){a(this,"init",arguments);this._onConnect=new lib.Callback;this._onDisconnect=new lib.Callback;this._requests={};this.onEvent=new lib.PubSub;this.onRequest=new lib.PubSub};this.disconnect=function(){this.transport.loseConnection()};this.onConnect=function(){this._onConnect.forward(arguments)};this.onDisconnect=function(){this._onDisconnect.forward(arguments)};
this.reset=function(){this._onConnect.reset();this._onDisconnect.reset()};this.connectionMade=function(){this._isConnected=!0;this._onConnect.fire()};this.connectionLost=function(b){for(var a in this._requests){var c=this._requests[a];delete this._requests[a];c._onError.fire(b)}this._isConnected=!1;this._onDisconnect.fire(b)};this.sendRequest=function(b,a,c,d){4<arguments.length&&(d=bind.apply(GLOBAL,Array.prototype.slice.call(arguments,3)));var e={name:b,args:a};c&&(e.target=c);e=this.sendFrame("RPC",
e);e=this._requests[e]=new RPCRequest(this,e);d&&(e.onSuccess(GLOBAL,d,!1),e.onError(GLOBAL,d));return e};this.sendEvent=function(b,a,c){this.sendFrame("EVENT",{name:b,args:a,target:c||null})};this.frameReceived=function(b,a,c){logger.debug("RECEIVED",b,a,c);switch(a.toUpperCase()){case "RESPONSE":var d=this._requests[c.id];if(!d)break;delete this._requests[c.id];d._onSuccess.fire(c.args);break;case "ERROR":var a=c.msg||"unknown",e=c.id,d=this._requests[e],b=Error(this,b,a,c.details,e);if(d)delete this._requests[e],
d._onError.fire(b);else return this.errorReceived&&this.errorReceived(b);break;case "RPC":case "EVENT":if(!c.name)return self.sendFrame("ERROR",{id:c.id||b,msg:'missing "name"'});var d=c.args||{},e=c.target||null,g="RPC"==a.toUpperCase(),a=g?this.onRequest:this.onEvent,d=new (g?ReceivedRequest:ReceivedEvent)(this,c.id||b,c.name,d,e);a.publish(d.name,d)}}});
